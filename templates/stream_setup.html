{% extends "base.html" %}

{% block content %}
<div class="card">
    <h1><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#dc3545"/><circle cx="12" cy="12" r="3" fill="white"/></svg> Start Live Stream</h1>
    {% if competition %}
    <h2><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L15.09 8.26L22 9L17 14L18.18 21L12 17.77L5.82 21L7 14L2 9L8.91 8.26L12 2Z" fill="#ffc107"/></svg> Premium Streaming Competition</h2>
    <p>Stream any game to earn KSh 15/hour + KSh 5 per viewer + performance bonuses!</p>
    {% else %}
    <h2>{{ match[1].upper() }} Match - KSh {{ match[4] }} Bet</h2>
    <p>Stream your real game screen to viewers and earn bonus rewards!</p>
    {% endif %}
</div>

<div class="card">
    <h3><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="3" width="20" height="14" rx="2" fill="#17a2b8"/><path d="M8 21L16 21" stroke="#17a2b8" stroke-width="2"/><path d="M12 17L12 21" stroke="#17a2b8" stroke-width="2"/></svg> Stream Setup</h3>
    
    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
        <!-- Stream Options -->
        <div>
            <h4>Stream Type</h4>
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem;">
                    <input type="radio" name="streamType" value="screen" checked> 
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="3" width="20" height="14" rx="2" stroke="currentColor" stroke-width="2"/><path d="M8 21L16 21" stroke="currentColor" stroke-width="2"/><path d="M12 17L12 21" stroke="currentColor" stroke-width="2"/></svg> Screen Share (Game Screen)
                </label>
                <label style="display: block; margin-bottom: 0.5rem;">
                    <input type="radio" name="streamType" value="camera"> 
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M23 7L16 12L23 17V7Z" fill="currentColor"/><rect x="1" y="5" width="15" height="14" rx="2" stroke="currentColor" stroke-width="2"/></svg> Camera Only
                </label>
                <label style="display: block; margin-bottom: 0.5rem;">
                    <input type="radio" name="streamType" value="both"> 
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="2" width="20" height="16" rx="2" stroke="currentColor" stroke-width="2"/><rect x="14" y="12" width="6" height="4" rx="1" fill="currentColor"/></svg> Screen + Camera (Picture-in-Picture)
                </label>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label>Stream Title:</label>
                <input type="text" id="streamTitle" 
                       value="{% if competition %}Competition Gaming Stream{% else %}{{ match[1].upper() }} Live Match{% endif %}" 
                       style="width: 100%; padding: 0.5rem; margin-top: 0.5rem;">
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="enableVoice" checked>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 1C10.34 1 9 2.34 9 4V12C9 13.66 10.34 15 12 15S15 13.66 15 12V4C15 2.34 13.66 1 12 1Z" fill="currentColor"/><path d="M19 10V12C19 16.42 15.42 20 11 20H13C17.42 20 21 16.42 21 12V10H19Z" fill="currentColor"/></svg> Enable Voice Commentary (Recommended)
                </label>
                <small style="color: #666;">Viewers can hear your voice + game audio</small>
            </div>
            
            <button onclick="startLiveStream()" class="btn btn-success" id="startStreamBtn" style="width: 100%;">
                🔴 Start Live Stream
            </button>
        </div>
        
        <!-- Neural Stream Preview -->
        <div style="flex: 2;">
            <h4>Neural Stream Preview</h4>
            <div id="previewArea" style="background: linear-gradient(45deg, #000, #1a1a2e); aspect-ratio: 21/9; border-radius: 15px; display: flex; align-items: center; justify-content: center; color: white; position: relative; overflow: hidden; border: 2px solid #00ff88; box-shadow: 0 0 30px rgba(0,255,136,0.3);">
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem; animation: pulse 2s infinite;">STREAM</div>
                    <h3>Neural Stream Engine Ready</h3>
                    <p>Next-gen streaming with AI optimization</p>
                </div>
                
                <!-- Futuristic overlay -->
                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at 50% 50%, rgba(0,255,136,0.1) 0%, transparent 70%); pointer-events: none;"></div>
            </div>
            
            <!-- Advanced Controls -->
            <div style="margin-top: 1rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem;">
                <button onclick="initOpponentStream()" class="btn btn-primary" id="opponentBtn">Dual Stream Mode</button>
                <button onclick="toggleStreamQuality()" class="btn btn-secondary" id="qualityBtn">8K Ultra</button>
                <button onclick="toggleAIEnhancement()" class="btn btn-warning" id="aiBtn">AI Enhance</button>
                <button onclick="toggleNeuralSync()" class="btn btn-info" id="syncBtn">Neural Sync</button>
            </div>
            
            <!-- Stream Analytics -->
            <div id="streamAnalytics" style="margin-top: 1rem; padding: 1rem; background: rgba(0,255,136,0.1); border-radius: 10px; display: none;">
                <h5>Real-time Analytics</h5>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; text-align: center;">
                    <div><strong id="fps">0</strong><br><small>FPS</small></div>
                    <div><strong id="bitrate">0</strong><br><small>Kbps</small></div>
                    <div><strong id="latency">0</strong><br><small>ms</small></div>
                    <div><strong id="viewers">0</strong><br><small>Viewers</small></div>
                </div>
            </div>
            
            <!-- Streamer Chat View -->
            <div id="streamerChat" style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 10px; display: none;">
                <h5>💬 Live Chat</h5>
                <div id="chatDisplay" style="height: 200px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 0.5rem; margin: 0.5rem 0;">
                    <div style="color: #666; text-align: center; padding: 2rem;">Chat messages will appear here...</div>
                </div>
                <button onclick="toggleChatView()" class="btn btn-secondary btn-sm" id="chatToggle">Hide Chat</button>
            </div>
        </div>
    </div>
</div>

<!-- Stream Instructions -->
<div class="card">
    <h3><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.89 22 5.99 22H18C19.1 22 20 21.1 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" fill="none"/><polyline points="14,2 14,8 20,8" stroke="currentColor" stroke-width="2"/></svg> Streaming Instructions</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
        <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px;">
            <h4 style="color: #28a745;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 12C6 9.79 7.79 8 10 8H14C16.21 8 18 9.79 18 12C18 14.21 16.21 16 14 16H10C7.79 16 6 14.21 6 12Z" stroke="#28a745" stroke-width="2"/><circle cx="9" cy="12" r="1" fill="#28a745"/><circle cx="15" cy="12" r="1" fill="#28a745"/></svg> Game Setup</h4>
            <ul style="margin: 0; padding-left: 1.5rem;">
                <li>Open your game first</li>
                <li>Set game to windowed/borderless</li>
                <li>Ensure stable internet connection</li>
                <li>Close unnecessary apps</li>
            </ul>
        </div>
        <div style="background: rgba(23, 162, 184, 0.1); padding: 1rem; border-radius: 8px;">
            <h4 style="color: #17a2b8;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="3" width="20" height="14" rx="2" stroke="#17a2b8" stroke-width="2"/><path d="M8 21L16 21" stroke="#17a2b8" stroke-width="2"/></svg> Screen Share</h4>
            <ul style="margin: 0; padding-left: 1.5rem;">
                <li>Select your game window</li>
                <li>Allow screen recording permission</li>
                <li>Keep game in focus while playing</li>
                <li>Avoid switching windows frequently</li>
            </ul>
        </div>
        <div style="background: rgba(255, 193, 7, 0.1); padding: 1rem; border-radius: 8px;">
            <h4 style="color: #ffc107;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="#ffc107" stroke-width="2"/><path d="M12 6V18M9 9H15M9 15H15" stroke="#ffc107" stroke-width="2"/></svg> Enhanced Earnings</h4>
            <ul style="margin: 0; padding-left: 1.5rem;">
                <li>Base match winnings: 84%</li>
                <li>Streaming bonus: +KSh 25-75</li>
                <li>Viewer engagement: KSh 5 per viewer</li>
                <li>Performance bonus: Up to KSh 200</li>
                <li>Sponsor rewards: KSh 50-500</li>
            </ul>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='streaming.js') }}"></script>
<script>
let localStream = null;
let streamActive = false;

let streamQuality = 'HD';
let opponentStreamActive = false;

let aiEnhanced = false;
let neuralSync = false;

window.initOpponentStream = async function() {
    const btn = document.getElementById('opponentBtn');
    
    if (opponentStreamActive) {
        resetPreviewArea();
        opponentStreamActive = false;
        btn.innerHTML = 'Dual Stream Mode';
        return;
    }
    
    try {
        // Create dual-stream interface first
        document.getElementById('previewArea').innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; height: 100%; position: relative;">
                <!-- Player 1 Stream (You) -->
                <div style="position: relative; background: linear-gradient(45deg, #000, #1a1a2e); border-radius: 10px; overflow: hidden; border: 1px solid #00ff88;">
                    <video id="player1Stream" autoplay muted style="width: 100%; height: 100%; object-fit: cover;"></video>
                    <div style="position: absolute; top: 10px; left: 10px; background: linear-gradient(45deg, #00ff88, #00cc6a); color: black; padding: 0.4rem 0.8rem; border-radius: 15px; font-weight: bold; font-size: 0.9rem;">
                        YOU
                    </div>
                    <div style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.8); color: #00ff88; padding: 0.3rem 0.6rem; border-radius: 8px; font-size: 0.8rem;">
                        LIVE
                    </div>
                </div>
                
                <!-- Player 2 Stream (Opponent) -->
                <div style="position: relative; background: linear-gradient(45deg, #000, #2e1a1a); border-radius: 10px; overflow: hidden; border: 1px solid #ff4757;">
                    <div id="opponentPlaceholder" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: white; text-align: center;">
                        <div>
                            <h3>Waiting for Opponent</h3>
                            <p>Opponent will appear here when they join</p>
                            <button onclick="connectToOpponent()" class="btn btn-primary btn-sm">Find Opponent</button>
                        </div>
                    </div>
                    <video id="player2Stream" autoplay muted style="width: 100%; height: 100%; object-fit: cover; display: none;"></video>
                    <div style="position: absolute; top: 10px; left: 10px; background: linear-gradient(45deg, #ff4757, #ff3742); color: white; padding: 0.4rem 0.8rem; border-radius: 15px; font-weight: bold; font-size: 0.9rem;">
                        OPPONENT
                    </div>
                    <div style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.8); color: #ff4757; padding: 0.3rem 0.6rem; border-radius: 8px; font-size: 0.8rem;">
                        WAITING
                    </div>
                </div>
            </div>
        `;
        
        // Set your stream to player 1
        if (localStream) {
            document.getElementById('player1Stream').srcObject = localStream;
        }
        
        opponentStreamActive = true;
        btn.innerHTML = 'Stop Dual Mode';
        
        // Show analytics
        document.getElementById('streamAnalytics').style.display = 'block';
        startAnalytics();
        
        alert('Dual stream mode activated! Your stream is on the left. Opponent will appear on the right when they join.');
        
    } catch (err) {
        alert('Dual stream setup failed: ' + err.message);
    }
}

function connectToOpponent() {
    // Simulate finding opponent stream
    const placeholder = document.getElementById('opponentPlaceholder');
    const video = document.getElementById('player2Stream');
    
    placeholder.style.display = 'none';
    video.style.display = 'block';
    
    // In real implementation, this would connect to actual opponent stream
    // For now, show a demo video or static image
    video.innerHTML = '<div style="width: 100%; height: 100%; background: linear-gradient(45deg, #ff4757, #ff3742); display: flex; align-items: center; justify-content: center; color: white;"><h3>Opponent Stream<br>Coming Soon</h3></div>';
    
    alert('Connected to opponent! (Demo mode - real opponent connection coming soon)');
}

function resetPreviewArea() {
    document.getElementById('previewArea').innerHTML = `
        <div style="text-align: center;">
            <div style="font-size: 4rem; margin-bottom: 1rem; animation: pulse 2s infinite;">STREAM</div>
            <h3>Neural Stream Engine Ready</h3>
            <p>Next-gen streaming with AI optimization</p>
        </div>
        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at 50% 50%, rgba(0,255,136,0.1) 0%, transparent 70%); pointer-events: none;"></div>
    `;
    document.getElementById('streamAnalytics').style.display = 'none';
}

window.toggleStreamQuality = function() {
    const btn = document.getElementById('qualityBtn');
    
    if (streamQuality === '8K Ultra') {
        streamQuality = '4K Pro';
        btn.innerHTML = '4K Pro';
    } else if (streamQuality === '4K Pro') {
        streamQuality = 'HD Neural';
        btn.innerHTML = 'HD Neural';
    } else {
        streamQuality = '8K Ultra';
        btn.innerHTML = '8K Ultra';
    }
    
    // Update analytics
    if (document.getElementById('bitrate')) {
        const bitrates = {'8K Ultra': 15000, '4K Pro': 8000, 'HD Neural': 4000};
        document.getElementById('bitrate').textContent = bitrates[streamQuality];
    }
}

window.toggleAIEnhancement = function() {
    const btn = document.getElementById('aiBtn');
    aiEnhanced = !aiEnhanced;
    
    if (aiEnhanced) {
        btn.innerHTML = 'AI Active';
        btn.className = 'btn btn-success';
        
        // Apply AI visual effects
        const videos = document.querySelectorAll('#previewArea video');
        videos.forEach(video => {
            video.style.filter = 'contrast(1.1) saturate(1.2) brightness(1.05)';
        });
    } else {
        btn.innerHTML = 'AI Enhance';
        btn.className = 'btn btn-warning';
        
        const videos = document.querySelectorAll('#previewArea video');
        videos.forEach(video => {
            video.style.filter = 'none';
        });
    }
}

window.toggleNeuralSync = function() {
    const btn = document.getElementById('syncBtn');
    const indicator = document.getElementById('neuralIndicator');
    neuralSync = !neuralSync;
    
    if (neuralSync) {
        btn.innerHTML = 'Sync Active';
        btn.className = 'btn btn-success';
        if (indicator) indicator.style.display = 'block';
        
        // Sync effect
        setTimeout(() => {
            if (indicator) indicator.style.display = 'none';
        }, 3000);
    } else {
        btn.innerHTML = 'Neural Sync';
        btn.className = 'btn btn-info';
        if (indicator) indicator.style.display = 'none';
    }
}

function startAnalytics() {
    let startTime = Date.now();
    let frameCount = 0;
    
    function updateRealAnalytics() {
        if (!document.getElementById('fps')) return;
        
        // Real FPS calculation
        frameCount++;
        const elapsed = (Date.now() - startTime) / 1000;
        const fps = Math.round(frameCount / elapsed);
        
        // Real network latency
        const start = performance.now();
        fetch('/ping').then(() => {
            const latency = Math.round(performance.now() - start);
            document.getElementById('latency').textContent = latency;
        }).catch(() => {
            document.getElementById('latency').textContent = 'N/A';
        });
        
        // Real viewer count from server
        if (currentStreamId) {
            fetch(`/stream_viewers/${currentStreamId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('viewers').textContent = data.count || 0;
                })
                .catch(() => {
                    document.getElementById('viewers').textContent = '0';
                });
        }
        
        document.getElementById('fps').textContent = Math.min(fps, 60);
        
        // Reset frame counter every 10 seconds
        if (elapsed > 10) {
            frameCount = 0;
            startTime = Date.now();
        }
    }
    
    setInterval(updateRealAnalytics, 1000);
}

window.startLiveStream = async function() {
    const streamType = document.querySelector('input[name="streamType"]:checked').value;
    const title = document.getElementById('streamTitle').value;
    const btn = document.getElementById('startStreamBtn');
    
    btn.disabled = true;
    btn.innerHTML = '🔄 Starting...';
    
    try {
        // Get user's screen/camera first
        let mediaStream;
        if (streamType === 'screen') {
            mediaStream = await navigator.mediaDevices.getDisplayMedia({
                video: { width: 1920, height: 1080 },
                audio: true
            });
        } else if (streamType === 'camera') {
            mediaStream = await navigator.mediaDevices.getUserMedia({
                video: { width: 1920, height: 1080 },
                audio: true
            });
        } else { // both
            mediaStream = await navigator.mediaDevices.getDisplayMedia({
                video: { width: 1920, height: 1080 },
                audio: true
            });
        }
        
        localStream = mediaStream;
        
        const response = await fetch('/api/create_real_stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title: title,
                type: streamType,
                competition: true
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            streamActive = true;
            currentStreamId = result.stream_id;
            
            btn.innerHTML = '⏹️ Stop Stream';
            btn.onclick = stopLiveStream;
            btn.disabled = false;
            btn.className = 'btn btn-danger';
            
            // Show actual stream preview
            document.getElementById('previewArea').innerHTML = `
                <div style="position: relative; height: 100%; border-radius: 15px; overflow: hidden;">
                    <video id="liveStreamVideo" autoplay muted style="width: 100%; height: 100%; object-fit: cover; border-radius: 15px;"></video>
                    <div style="position: absolute; top: 15px; left: 15px; background: linear-gradient(45deg, #dc3545, #c82333); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-weight: bold; box-shadow: 0 2px 10px rgba(220,53,69,0.3);">
                        🔴 LIVE
                    </div>
                    <div style="position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.8); color: white; padding: 0.5rem 1rem; border-radius: 15px; font-size: 0.9rem;">
                        Stream ID: ${result.stream_id}
                    </div>
                    <div style="position: absolute; bottom: 15px; left: 15px; background: rgba(0,0,0,0.8); color: #00ff88; padding: 0.5rem 1rem; border-radius: 15px; font-size: 0.9rem;">
                        Viewers: <span id="liveViewers">0</span> | Earning KSh 15/hr
                    </div>
                </div>
            `;
            
            // Connect stream to video element
            document.getElementById('liveStreamVideo').srcObject = mediaStream;
            
            document.getElementById('streamAnalytics').style.display = 'block';
            document.getElementById('streamerChat').style.display = 'block';
            startAnalytics();
            startChatMonitoring();
            
            alert('🔴 STREAM STARTED! Your screen is now live!');
        } else {
            throw new Error(result.error || 'Stream start failed');
        }
        
    } catch (err) {
        btn.innerHTML = '🔴 Start Live Stream';
        btn.disabled = false;
        btn.className = 'btn btn-success';
        
        if (err.name === 'NotAllowedError') {
            alert('Screen sharing permission denied. Please allow screen access to start streaming.');
        } else {
            alert('Failed to start stream: ' + err.message);
        }
    }
}

async function stopLiveStream() {
    const btn = document.getElementById('startStreamBtn');
    
    // Disable button during stop
    btn.disabled = true;
    btn.innerHTML = '🔄 Stopping...';
    
    try {
        if (window.streamingEngine) {
            await window.streamingEngine.stopStream();
        }
        
        streamActive = false;
        currentStreamId = null;
        
        // Reset UI
        btn.innerHTML = '🔴 Start Live Stream';
        btn.onclick = startLiveStream;
        btn.disabled = false;
        btn.className = 'btn btn-success';
        
        // Hide analytics and chat
        document.getElementById('streamAnalytics').style.display = 'none';
        document.getElementById('streamerChat').style.display = 'none';
        
        // Reset preview
        resetPreviewArea();
        
        alert('Stream stopped successfully!');
        
    } catch (err) {
        console.error('Stream stop error:', err);
        
        // Reset button anyway
        btn.innerHTML = '🔴 Start Live Stream';
        btn.onclick = startLiveStream;
        btn.disabled = false;
        btn.className = 'btn btn-success';
        
        alert('Stream stopped (with errors): ' + err.message);
    }
}

function startRealAnalytics() {
    setInterval(() => {
        if (!streamActive) return;
        
        // Real viewer count from WebRTC connections
        const viewerCount = window.streamingEngine.viewers.size;
        if (document.getElementById('viewers')) {
            document.getElementById('viewers').textContent = viewerCount;
        }
        
        // Real FPS from video track
        if (window.streamingEngine.localStream) {
            const videoTrack = window.streamingEngine.localStream.getVideoTracks()[0];
            if (videoTrack) {
                const settings = videoTrack.getSettings();
                if (document.getElementById('fps')) {
                    document.getElementById('fps').textContent = settings.frameRate || 30;
                }
            }
        }
        
        // Real bitrate calculation
        window.streamingEngine.peerConnections.forEach(async (pc) => {
            try {
                const stats = await pc.getStats();
                stats.forEach(report => {
                    if (report.type === 'outbound-rtp' && report.mediaType === 'video') {
                        const bitrate = Math.round(report.bytesSent * 8 / 1000);
                        if (document.getElementById('bitrate')) {
                            document.getElementById('bitrate').textContent = bitrate;
                        }
                    }
                });
            } catch (e) {}
        });
        
        // Network latency
        const start = performance.now();
        fetch('/ping').then(() => {
            const latency = Math.round(performance.now() - start);
            if (document.getElementById('latency')) {
                document.getElementById('latency').textContent = latency;
            }
        }).catch(() => {});
        
    }, 2000);
}

function startChatMonitoring() {
    if (!currentStreamId) return;
    
    function loadStreamChat() {
        fetch(`/get_stream_chat/${currentStreamId}`)
            .then(response => response.json())
            .then(data => {
                const chatDiv = document.getElementById('chatDisplay');
                if (data.messages && data.messages.length > 0) {
                    chatDiv.innerHTML = data.messages.map(msg => {
                        const time = new Date(msg.time).toLocaleTimeString();
                        return `<div style="margin-bottom: 0.5rem; padding: 0.3rem; background: rgba(255,255,255,0.05); border-radius: 5px;">
                            <strong style="color: #00ff88;">${msg.username}</strong> 
                            <small style="color: #666;">${time}</small><br>
                            <span>${msg.message}</span>
                        </div>`;
                    }).join('');
                    chatDiv.scrollTop = chatDiv.scrollHeight;
                } else {
                    chatDiv.innerHTML = '<div style="color: #666; text-align: center; padding: 2rem;">No chat messages yet...</div>';
                }
            })
            .catch(err => console.log('Chat load failed:', err));
    }
    
    loadStreamChat();
    setInterval(loadStreamChat, 3000);
}

function toggleChatView() {
    const chatDiv = document.getElementById('streamerChat');
    const btn = document.getElementById('chatToggle');
    
    if (chatDiv.style.display === 'none') {
        chatDiv.style.display = 'block';
        btn.innerHTML = 'Hide Chat';
    } else {
        chatDiv.style.display = 'none';
        btn.innerHTML = 'Show Chat';
    }
}

let mediaRecorder;
let recordedChunks = [];

function startRecording(stream) {
    recordedChunks = [];
    mediaRecorder = new MediaRecorder(stream, {
        mimeType: 'video/webm;codecs=vp9'
    });
    
    mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
            recordedChunks.push(event.data);
        }
    };
    
    mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `stream-recording-${Date.now()}.webm`;
        a.click();
    };
    
    mediaRecorder.start(1000); // Record in 1-second chunks
}

function toggleRecording() {
    const btn = document.getElementById('recordBtn');
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        if (confirm('Stop recording? Your recorded video will be downloaded.')) {
            mediaRecorder.stop();
            btn.innerHTML = '⏺️ Record';
            btn.className = 'btn btn-danger btn-sm';
            
            // Show recording stopped indicator
            const liveIndicator = document.querySelector('[style*="LIVE RECORDING"]');
            if (liveIndicator) {
                liveIndicator.innerHTML = '📺 LIVE STREAM';
                liveIndicator.style.background = '#28a745';
            }
        }
    } else if (localStream) {
        startRecording(localStream);
        btn.innerHTML = '⏹️ Stop Recording';
        btn.className = 'btn btn-success btn-sm';
        
        // Update live indicator
        const liveIndicator = document.querySelector('[style*="LIVE STREAM"]');
        if (liveIndicator) {
            liveIndicator.innerHTML = '🔴 LIVE RECORDING';
            liveIndicator.style.background = '#dc3545';
        }
    }
}

function toggleMiniPlayer() {
    const video = document.getElementById('liveStreamVideo');
    if (video) {
        if (document.pictureInPictureElement) {
            document.exitPictureInPicture();
        } else {
            video.requestPictureInPicture().catch(err => {
                alert('Picture-in-Picture not supported');
            });
        }
    }
}

let currentStreamId = null;

function testStream() {
    const btn = document.getElementById('startStreamBtn');
    btn.innerHTML = 'Testing...';
    
    setTimeout(() => {
        btn.innerHTML = 'Stream Active!';
        alert('Stream test complete!');
    }, 2000);
}



function showViewers() {
    if (currentStreamId) {
        fetch(`/stream_viewers/${currentStreamId}`)
            .then(response => response.json())
            .then(data => {
                if (data.viewers) {
                    let viewerList = `Current Viewers (${data.count}):\n\n`;
                    data.viewers.forEach(viewer => {
                        viewerList += `• ${viewer.username}\n`;
                    });
                    alert(viewerList || 'No viewers currently watching');
                } else {
                    alert('Unable to load viewer list');
                }
            })
            .catch(err => {
                alert('Error loading viewers');
            });
    }
}

// Update viewer count every 10 seconds
setInterval(() => {
    if (currentStreamId && streamActive) {
        fetch(`/stream_viewers/${currentStreamId}`)
            .then(response => response.json())
            .then(data => {
                if (data.count !== undefined) {
                    const qualityDiv = document.querySelector('[style*="bottom: 10px; left: 10px"]');
                    if (qualityDiv) {
                        qualityDiv.innerHTML = `Quality: HD 1080p | Audio: ${document.getElementById('enableVoice').checked ? 'ON' : 'Game Only'} | Viewers: ${data.count}`;
                    }
                }
            })
            .catch(err => console.log('Viewer update failed'));
    }
}, 10000);

// Keyboard shortcut to stop recording (Ctrl+R)
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'r' && mediaRecorder && mediaRecorder.state === 'recording') {
        e.preventDefault();
        toggleRecording();
    }
});

// Stop stream and recording when leaving page
window.addEventListener('beforeunload', () => {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
    }
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
    }
});
</script>
{% endblock %}