{% extends "base.html" %}

{% block content %}
<!-- Font Awesome CDN for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<div class="card">
    <h1>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="red">
            <circle cx="12" cy="12" r="8"/>
        </svg>
        LIVE Streaming Hub
    </h1>
    
    <!-- Stream Creation Interface -->
    <div class="stream-match-creator">
        <h3><i class="fas fa-circle text-danger"></i> Create High-Quality Stream</h3>
        <div class="quality-selector">
            <select id="streamQuality">
                <option value="mobile-hq"><i class="fas fa-mobile-alt"></i> Mobile HQ (720p30)</option>
                <option value="pc-ultra"><i class="fas fa-desktop"></i> PC Ultra (1080p60)</option>
                <option value="console-pro"><i class="fas fa-gamepad"></i> Console Pro (4K60)</option>
            </select>
            <button onclick="createHQStream()" class="btn btn-success">Start Free Stream</button>
        </div>
    </div>
    
    <!-- Premium Features -->
    <div class="premium-features">
        <h3><i class="fas fa-crown"></i> Premium Features</h3>
        <div class="features-grid">
            <div class="feature-card">
                <i class="fas fa-hd-video"></i>
                <h4>HD Quality</h4>
                <p>Stream in 1080p HD quality</p>
                <button onclick="upgradeHD()" class="btn btn-warning">KSh 30</button>
            </div>
            
            <div class="feature-card">
                <i class="fas fa-palette"></i>
                <h4>Custom Overlay</h4>
                <p>Add your logo and graphics</p>
                <button onclick="addOverlay()" class="btn btn-warning">KSh 25</button>
            </div>
            
            <div class="feature-card">
                <i class="fas fa-rocket"></i>
                <h4>Boost Stream</h4>
                <p>Top placement for 24 hours</p>
                <button onclick="boostStream()" class="btn btn-warning">KSh 40</button>
            </div>
            
            <div class="feature-card">
                <i class="fas fa-video"></i>
                <h4>Multi-Camera</h4>
                <p>Stream from multiple angles</p>
                <button onclick="enableMultiCam()" class="btn btn-warning">KSh 50</button>
            </div>
            
            <div class="feature-card">
                <i class="fas fa-chart-line"></i>
                <h4>Analytics Pro</h4>
                <p>Detailed viewer insights</p>
                <button onclick="getAnalytics()" class="btn btn-warning">KSh 20</button>
            </div>
        </div>
    </div>
    
    <!-- Active Streams -->
    <div class="active-streams">
        <h3><i class="fas fa-broadcast-tower"></i> Live Streams</h3>
        <div id="liveStreams">
            <!-- Streams will load here -->
        </div>
    </div>
</div>

<!-- Streaming Interface -->
<div id="streamingInterface" style="display: none;" class="card">
    <h3><i class="fas fa-video"></i> Your Live Stream</h3>
    
    <!-- Local video preview -->
    <div class="stream-preview">
        <video id="localVideo" autoplay muted style="width: 100%; max-width: 640px; border-radius: 8px;"></video>
        <div class="stream-controls">
            <button onclick="stopHQStream()" class="btn btn-danger">
                <i class="fas fa-stop"></i> Stop Stream
            </button>
            <button onclick="toggleAudio()" class="btn btn-secondary">
                <i class="fas fa-microphone"></i> Toggle Audio
            </button>
        </div>
    </div>
    
    <!-- Live stats -->
    <div class="live-stats">
        <div class="stat-item">
            <i class="fas fa-users"></i>
            <span>Viewers: <span id="viewerCount">0</span></span>
        </div>
        <div class="stat-item">
            <i class="fas fa-coins"></i>
            <span>Earnings: KSh <span id="liveEarnings">0</span></span>
        </div>
        <div class="stat-item">
            <i class="fas fa-clock"></i>
            <span>Duration: <span id="streamDuration">00:00</span></span>
        </div>
    </div>
</div>

<!-- Viewer Interface -->
<div class="hq-viewer-interface" style="display: none;">
    <video id="hqGameVideo" autoplay style="width: 100%; border-radius: 8px;"></video>
    
    <!-- Live overlay -->
    <div class="live-overlay">
        <div class="match-info">
            <span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M21,6V8H3V6H21M7,10V12H5V10H7M19,10V12H17V10H19M8,10H16V12H8V10Z"/>
                </svg>
                <span id="gameInfo">Game Stream</span>
            </span>
            <span>
                <i class="fas fa-users"></i> <span id="viewersWatching">0</span> watching
            </span>
        </div>
        
        <!-- Viewer actions -->
        <div class="viewer-rewards">
            <button onclick="tipStreamer(10)" class="btn btn-success">
                <i class="fas fa-gem"></i> Tip KSh 10
            </button>
            <button onclick="tipStreamer(25)" class="btn btn-success">
                <i class="fas fa-gem"></i> Tip KSh 25
            </button>
            <button onclick="predictWinner()" class="btn btn-info">
                <i class="fas fa-bullseye"></i> Predict Winner
            </button>
        </div>
    </div>
</div>

<style>
.stream-match-creator {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    color: white;
}

.quality-selector {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-top: 1rem;
}

.quality-selector select {
    padding: 0.5rem;
    border-radius: 6px;
    border: none;
    background: white;
    color: #333;
}

.premium-features {
    margin: 2rem 0;
}

.features-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.feature-card {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    text-align: center;
    border: 1px solid #dee2e6;
    transition: transform 0.2s;
}

.feature-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.feature-card i {
    font-size: 2rem;
    color: #007bff;
    margin-bottom: 1rem;
}

.stream-preview {
    text-align: center;
    margin-bottom: 1rem;
}

.stream-controls {
    margin-top: 1rem;
    display: flex;
    gap: 1rem;
    justify-content: center;
}

.live-stats {
    display: flex;
    gap: 2rem;
    justify-content: center;
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: bold;
}

.live-overlay {
    position: absolute;
    top: 10px;
    left: 10px;
    right: 10px;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 1rem;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.viewer-rewards {
    display: flex;
    gap: 0.5rem;
}

.viewer-rewards button {
    padding: 0.3rem 0.8rem;
    font-size: 0.8rem;
}
</style>

<script>
class GameStreamHQ {
    constructor() {
        this.roomId = null;
        this.stream = null;
        this.peer = null;
        this.viewers = new Set();
        this.earnings = 0;
        this.startTime = null;
        this.socket = io();
    }
    
    async createHQStream() {
        const quality = document.getElementById('streamQuality').value;
        
        try {
            // Get stream configuration
            const response = await fetch('/create_hq_stream', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({quality: quality, device: this.detectDevice()})
            });
            
            const data = await response.json();
            if (data.success) {
                this.roomId = data.room_id;
                await this.startHQStream(data.config);
                document.getElementById('streamingInterface').style.display = 'block';
                this.startEarningsTracker();
            }
        } catch (error) {
            alert('Failed to create stream: ' + error.message);
        }
    }
    
    async startHQStream(config) {
        try {
            // Get optimized stream based on device
            if (this.isMobile()) {
                this.stream = await this.getMobileGameStream();
            } else {
                this.stream = await this.getPCGameStream();
            }
            
            // Show local preview
            document.getElementById('localVideo').srcObject = this.stream;
            
            // Setup WebRTC
            this.peer = new RTCPeerConnection({
                iceServers: [{urls: 'stun:stun.l.google.com:19302'}]
            });
            
            // Add stream tracks
            this.stream.getTracks().forEach(track => {
                this.peer.addTrack(track, this.stream);
            });
            
            // Start streaming
            this.socket.emit('start_hq_stream', {
                room: this.roomId,
                quality: config
            });
            
            this.startTime = Date.now();
            
        } catch (error) {
            alert('Camera/screen access denied. Please allow permissions and try again.');
        }
    }
    
    async getMobileGameStream() {
        // Mobile: Use back camera to capture screen
        const constraints = {
            video: {
                width: {ideal: 1280},
                height: {ideal: 720},
                frameRate: {ideal: 30},
                facingMode: 'environment'
            },
            audio: {
                echoCancellation: true,
                noiseSuppression: true
            }
        };
        
        return await navigator.mediaDevices.getUserMedia(constraints);
    }
    
    async getPCGameStream() {
        // PC: Screen capture
        const constraints = {
            video: {
                width: {ideal: 1920},
                height: {ideal: 1080},
                frameRate: {ideal: 60}
            },
            audio: true
        };
        
        return await navigator.mediaDevices.getDisplayMedia(constraints);
    }
    
    startEarningsTracker() {
        setInterval(() => {
            const viewerCount = this.viewers.size;
            const minutes = Math.floor((Date.now() - this.startTime) / 60000);
            
            // Earnings calculation: KSh 3/min + KSh 5/viewer/min
            const baseEarnings = minutes * 3;
            const viewerBonus = viewerCount * minutes * 5;
            this.earnings = baseEarnings + viewerBonus;
            
            // Update UI
            document.getElementById('liveEarnings').textContent = this.earnings;
            document.getElementById('viewerCount').textContent = viewerCount;
            document.getElementById('streamDuration').textContent = this.formatTime(minutes);
            
            // Send to backend
            fetch('/update_stream_earnings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    room_id: this.roomId,
                    earnings: this.earnings,
                    viewers: viewerCount,
                    duration: minutes
                })
            });
        }, 60000); // Every minute
    }
    
    stopHQStream() {
        if (this.stream) {
            this.stream.getTracks().forEach(track => track.stop());
        }
        if (this.peer) {
            this.peer.close();
        }
        
        // Send final earnings to backend
        fetch('/end_hq_stream', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                room_id: this.roomId,
                final_earnings: this.earnings
            })
        });
        
        document.getElementById('streamingInterface').style.display = 'none';
        alert(`Stream ended! You earned KSh ${this.earnings}`);
    }
    
    detectDevice() {
        if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            return 'mobile';
        }
        return 'desktop';
    }
    
    isMobile() {
        return this.detectDevice() === 'mobile';
    }
    
    formatTime(minutes) {
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
    }
}

// Initialize streaming system
const streamHQ = new GameStreamHQ();

// Global functions
function createHQStream() {
    streamHQ.createHQStream();
}

function stopHQStream() {
    streamHQ.stopHQStream();
}

function upgradeHD() {
    if (confirm('Upgrade to HD quality for KSh 30?')) {
        fetch('/upgrade_hd', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('HD quality activated!');
            } else {
                alert('Insufficient balance');
            }
        });
    }
}

function addOverlay() {
    if (confirm('Add custom overlay for KSh 25?')) {
        fetch('/add_custom_overlay', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({overlay: 'gaming_pro'})
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Custom overlay activated!');
            }
        });
    }
}

function boostStream() {
    if (confirm('Boost stream to top for KSh 40?')) {
        fetch('/boost_stream', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Stream boosted to top placement!');
            }
        });
    }
}

function enableMultiCam() {
    if (confirm('Enable multi-camera for KSh 50?')) {
        fetch('/enable_multi_cam', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Multi-camera enabled!');
            }
        });
    }
}

function getAnalytics() {
    if (confirm('Get premium analytics for KSh 20?')) {
        fetch('/premium_analytics', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Analytics unlocked! Check your dashboard.');
            }
        });
    }
}

function tipStreamer(amount) {
    if (confirm(`Tip streamer KSh ${amount}?`)) {
        fetch('/tip_streamer', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({amount: amount, room_id: currentRoomId})
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Tip sent! Streamer earned KSh ${data.streamer_amount}`);
            }
        });
    }
}

// Load live streams on page load
function loadLiveStreams() {
    fetch('/api/live_streams')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('liveStreams');
            if (data.streams && data.streams.length > 0) {
                container.innerHTML = data.streams.map(stream => `
                    <div class="stream-card" style="background: rgba(220,53,69,0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #dc3545;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${stream.title}</strong>
                                <span style="background: #dc3545; color: white; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.8rem; margin-left: 1rem;">LIVE</span>
                                <br>
                                <small>Streamer: ${stream.username} | Viewers: ${stream.viewers} | Game: ${stream.game || 'Gaming'}</small>
                            </div>
                            <div>
                                <button onclick="watchHQStream(${stream.id})" class="btn btn-primary btn-sm">
                                    <i class="fas fa-eye"></i> Watch
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p style="text-align: center; opacity: 0.6;">No live streams currently active</p>';
            }
        })
        .catch(error => {
            console.error('Error loading streams:', error);
            document.getElementById('liveStreams').innerHTML = '<p style="color: #dc3545;">Error loading live streams</p>';
        });
}

function watchHQStream(streamId) {
    window.location.href = `/watch_hq_stream/${streamId}`;
}

// Load streams on page load
document.addEventListener('DOMContentLoaded', function() {
    loadLiveStreams();
    setInterval(loadLiveStreams, 30000); // Refresh every 30 seconds
});
</script>
{% endblock %}