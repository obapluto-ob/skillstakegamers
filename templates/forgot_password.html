{% extends "base.html" %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        {% if session['reset_code'] %}
        <h2>Enter Reset Code</h2>
        <p>We've sent a 6-digit code to your email. Enter it below with your new password.</p>
        <form method="POST">
            <div class="form-group">
                <label>Reset Code</label>
                <input type="text" name="reset_code" class="form-control" placeholder="Enter 6-digit code" required maxlength="6">
            </div>
            <div class="form-group">
                <label>New Password</label>
                <div style="position: relative;">
                    <input type="password" id="new_password" name="new_password" class="form-control" placeholder="Enter new password" required minlength="6">
                    <button type="button" onclick="togglePassword('new_password')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 12px;">Show</button>
                </div>
            </div>
            <div class="form-group">
                <label>Confirm Password</label>
                <div style="position: relative;">
                    <input type="password" id="confirm_password" name="confirm_password" class="form-control" placeholder="Confirm new password" required minlength="6">
                    <button type="button" onclick="togglePassword('confirm_password')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 12px;">Show</button>
                </div>
            </div>
            <button type="submit" class="btn auth-btn">Reset Password</button>
        </form>
        
        <div class="resend-section" style="margin-top: 1rem; text-align: center;">
            <p style="color: #666; margin-bottom: 0.5rem;">Didn't receive the code?</p>
            <button id="resend-reset-btn" onclick="resendResetCode()" class="btn btn-secondary">Resend Reset Code</button>
            <div id="reset-cooldown-timer" class="cooldown-timer" style="display: none; margin-top: 0.5rem; color: #ff6b6b; font-size: 0.9rem;">
                <p>Please wait <span id="reset-countdown">60</span> seconds before requesting another code</p>
            </div>
        </div>
        {% else %}
        <h2>Reset Password</h2>
        <form method="POST">
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" name="email" class="form-control" placeholder="Enter your email" required>
            </div>
            <button type="submit" class="btn auth-btn">Send Reset Code</button>
        </form>
        {% endif %}
        <p class="auth-link">
            Remember your password? <a href="{{ url_for('login') }}">Login here</a>
        </p>
    </div>
</div>

<script>
function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const button = field.nextElementSibling;
    
    if (field.type === 'password') {
        field.type = 'text';
        button.innerHTML = 'Hide';
    } else {
        field.type = 'password';
        button.innerHTML = 'Show';
    }
}

let resetCooldown = 0;
let resetCooldownInterval;

function resendResetCode() {
    const resendBtn = document.getElementById('resend-reset-btn');
    
    if (resetCooldown > 0) {
        return;
    }
    
    resendBtn.disabled = true;
    resendBtn.textContent = 'Sending...';
    
    fetch('/resend_forgot_password_code', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ code_type: 'forgot_password' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            startResetCooldown(60);
        } else {
            alert(data.message || 'Failed to resend reset code');
            resendBtn.disabled = false;
            resendBtn.textContent = 'Resend Reset Code';
        }
    })
    .catch(error => {
        alert('Error resending code. Please try again.');
        resendBtn.disabled = false;
        resendBtn.textContent = 'Resend Reset Code';
    });
}

function startResetCooldown(seconds) {
    const resendBtn = document.getElementById('resend-reset-btn');
    const cooldownTimer = document.getElementById('reset-cooldown-timer');
    const countdown = document.getElementById('reset-countdown');
    
    resetCooldown = seconds;
    resendBtn.style.display = 'none';
    cooldownTimer.style.display = 'block';
    
    resetCooldownInterval = setInterval(() => {
        resetCooldown--;
        countdown.textContent = resetCooldown;
        
        if (resetCooldown <= 0) {
            clearInterval(resetCooldownInterval);
            resendBtn.style.display = 'inline-block';
            resendBtn.disabled = false;
            resendBtn.textContent = 'Resend Reset Code';
            cooldownTimer.style.display = 'none';
        }
    }, 1000);
}

// Start initial cooldown if on reset code page
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('resend-reset-btn')) {
        startResetCooldown(60);
    }
});
</script>
<style>
.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    background-color: #ccc;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
}

.btn-secondary:hover:not(:disabled) {
    background-color: #5a6268;
}
</style>
{% endblock %}