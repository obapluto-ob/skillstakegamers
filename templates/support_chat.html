{% extends "base.html" %}

{% block content %}
<div class="card" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none;">
    <h1>💬 Live Support Chat</h1>
    <p>Connect with our support team - Real humans helping real gamers</p>
</div>

<div class="card">
    <div id="chatMessages" style="height: 400px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.2); padding: 1rem; margin-bottom: 1rem; background: rgba(0,0,0,0.2);">
        <div class="bot-message">
            <strong>👨‍💼 Alex (Support Agent):</strong> Hey {{ session.username }}! Welcome to SkillStake support. I'm here to help you with anything you need.
            <div style="background: rgba(0,255,136,0.1); padding: 0.5rem; margin: 0.5rem 0; border-radius: 4px;">
                <strong>🚀 I can help you with:</strong>
                <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                    <li>💰 Deposits & Withdrawals</li>
                    <li>🎮 Game Issues & Rules</li>
                    <li>🔧 Technical Problems</li>
                    <li>🔒 Account Security</li>
                    <li>🏆 Tournament Questions</li>
                </ul>
            </div>
            I can see your current balance is <strong>KSh {{ session.balance or 0 }}</strong>. What can I help you with today?
        </div>
    </div>
    
    <div style="display: flex; gap: 0.5rem;">
        <input type="text" id="userMessage" placeholder="Type your question..." 
               style="flex: 1; padding: 0.5rem; border: 1px solid #444; background: #2a2a2a; color: white; border-radius: 4px;"
               onkeypress="if(event.key==='Enter') sendMessage()">
        <button onclick="sendMessage()" class="btn btn-primary">Send</button>
    </div>
    
    <!-- Quick Help Buttons -->
    <div style="margin-top: 1rem;">
        <h3>Quick Help:</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
            <button onclick="quickMessage('How do I deposit money?')" class="btn btn-secondary">DEPOSIT PROTOCOL</button>
            <button onclick="quickMessage('How do I withdraw money?')" class="btn btn-secondary">WITHDRAWAL SYSTEM</button>
            <button onclick="quickMessage('How do tournaments work?')" class="btn btn-secondary">TOURNAMENT MATRIX</button>
            <button onclick="quickMessage('My balance is wrong')" class="btn btn-secondary">BALANCE AUDIT</button>
            <button onclick="quickMessage('How do I invite friends?')" class="btn btn-secondary">REFERRAL ENGINE</button>
        </div>
    </div>
</div>

<script>
const responses = {
    'deposit': {
        keywords: ['deposit', 'add money', 'fund', 'mpesa', 'pay', 'how do i deposit', 'paybill', 'till'],
        response: `Sure! I'll walk you through depositing money. It's really simple:
        
        📱 **M-Pesa (Most Popular):**
        1. Go to your Wallet page
        2. Click "Add Funds" 
        3. Enter amount (minimum KSh 100)
        4. Fill in your M-Pesa number and name
        5. Upload a clear screenshot of your M-Pesa receipt
        6. I'll approve it within 30 minutes!
        
        💳 **Other Options:**
        - PayPal: Instant deposit, 3% fee
        - Crypto: USDT deposits, 2% fee
        
        The M-Pesa fee is 5%, but it's the fastest way. Need help with any specific step?`
    },
    'withdraw': {
        keywords: ['withdraw', 'cash out', 'get money', 'how do i withdraw'],
        response: `To withdraw money:
        1. Go to Wallet page
        2. Click "Withdraw"
        3. Enter amount and M-Pesa number
        4. Admin processes within 2 hours
        
        💡 Tip: KSh 25 withdrawal fee applies. Minimum: KSh 100`
    },
    'tournament': {
        keywords: ['tournament', 'competition', 'bracket', 'how do tournaments work'],
        response: `Tournaments work like this:
        1. Pay entry fee to join
        2. Wait for tournament to fill up
        3. Play elimination matches
        4. Top 8 players share 80% of prize pool
        
        🏆 Prize Distribution:
        1st: 35% | 2nd: 20% | 3rd: 12% | 4th: 8%
        5th-8th: 1.25% each`
    },
    'balance': {
        keywords: ['balance', 'money wrong', 'missing funds', 'my balance is wrong'],
        response: `If your balance is wrong:
        1. Check your transaction history
        2. Look for pending deposits/withdrawals
        3. Contact admin if still incorrect
        
        💡 Common causes:
        - Pending deposit approval
        - Match bet deductions
        - Withdrawal processing`
    },
    'referral': {
        keywords: ['referral', 'invite', 'friend', 'bonus', 'how do i invite friends'],
        response: `Referral System:
        1. Go to Referrals page to get your code
        2. Friends use your code when registering
        3. You get KSh 50 bonus per friend
        4. You earn 4% of their losses forever!
        
        💰 More friends = More money!`
    },
    'rules': {
        keywords: ['rules', 'how to play', 'game'],
        response: `Game Rules:
        1. Create/Join match with bet amount
        2. Both players confirm in lobby
        3. Play your game (PUBG, FIFA, etc.)
        4. Submit result with screenshot
        5. Winner gets 84% of total pot
        
        ⚠️ Important: Always take screenshots of final results!`
    },
    'technical': {
        keywords: ['lag', 'slow', 'loading', 'crash', 'bug', 'glitch', 'not working'],
        response: `🔧 TECHNICAL DIAGNOSTICS INITIATED:
        
        🔍 PERFORMANCE OPTIMIZATION:
        1. Clear browser cache (Ctrl+Shift+Del)
        2. Close unnecessary tabs/apps
        3. Use Chrome/Firefox for best performance
        4. Check internet speed (min 2 Mbps)
        
        📱 MOBILE USERS:
        - Use latest browser version
        - Enable JavaScript
        - Disable data saver mode
        
        ⚡ STILL HAVING ISSUES? Type 'emergency' for priority support.`
    },
    'security': {
        keywords: ['hack', 'secure', 'safe', 'password', 'account', 'login'],
        response: `🔒 SECURITY PROTOCOL ACTIVATED:
        
        🔐 ACCOUNT PROTECTION:
        - Use strong passwords (8+ characters)
        - Never share login details
        - Log out on shared devices
        - Enable 2FA when available
        
        🚨 SUSPICIOUS ACTIVITY?
        1. Change password immediately
        2. Check transaction history
        3. Contact admin: +254729237059
        
        📊 YOUR ACCOUNT: Secure & Protected`
    },
    'default': {
        keywords: [],
        response: `I'm here to help! I handle most support issues, but if you need something more complex, I can always get my supervisor involved.
        
        🚀 **I'm great with:**
        • Deposit & withdrawal questions
        • Game rules and strategies  
        • Technical troubleshooting
        • Account security concerns
        • Tournament information
        
        Just tell me what's going on and I'll do my best to help. If I can't solve it, I'll make sure someone who can gets involved right away.
        
        What's on your mind?`
    }
};

function sendMessage() {
    const input = document.getElementById('userMessage');
    const message = input.value.trim();
    if (!message) return;
    
    addMessage('user', message);
    input.value = '';
    
    // Simple AI response
    setTimeout(() => {
        const response = getBotResponse(message);
        addMessage('bot', response);
    }, 1000);
}

function quickMessage(message) {
    addMessage('user', message);
    
    // Get bot response for quick messages
    setTimeout(() => {
        const response = getBotResponse(message);
        addMessage('bot', response);
    }, 500);
}

function addMessage(sender, message) {
    const chatDiv = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = sender === 'user' ? 'user-message' : 'bot-message';
    messageDiv.style.cssText = `
        margin: 1rem 0; 
        padding: 0.5rem; 
        border-radius: 8px; 
        background: ${sender === 'user' ? 'rgba(0,255,136,0.1)' : 'rgba(255,255,255,0.1)'};
    `;
    
    const agentName = sender === 'user' ? 'You' : 'Alex (Support)';
    messageDiv.innerHTML = `<strong>${agentName}:</strong> ${message.replace(/\\n/g, '<br>')}`;
    chatDiv.appendChild(messageDiv);
    chatDiv.scrollTop = chatDiv.scrollHeight;
}

let failedAttempts = parseInt(localStorage.getItem('failedAttempts') || '0');
const maxAttempts = 3;

function getBotResponse(message) {
    const lowerMessage = message.toLowerCase();
    
    // Advanced AI processing with context awareness
    const userBalance = {{ session.balance or 0 }};
    const username = '{{ session.username }}';
    
    // Intelligent keyword matching with context
    for (const [key, data] of Object.entries(responses)) {
        if (key === 'default') continue;
        
        if (data.keywords.some(keyword => lowerMessage.includes(keyword))) {
            failedAttempts = 0;
            localStorage.setItem('failedAttempts', '0');
            
            // Personalize response based on user context
            let personalizedResponse = data.response;
            
            if (key === 'balance' && userBalance > 0) {
                personalizedResponse += `\n\n📊 YOUR CURRENT BALANCE: KSh ${userBalance}`;
            }
            
            if (key === 'deposit' && userBalance < 100) {
                personalizedResponse += `\n\n⚠️ NOTICE: Low balance detected. Recommended deposit: KSh 500+`;
            }
            
            return personalizedResponse;
        }
    }
    
    // Advanced pattern recognition
    if (lowerMessage.includes('stuck') || lowerMessage.includes('error') || lowerMessage.includes('problem')) {
        return `🔧 DIAGNOSTIC MODE ACTIVATED for ${username}:
        
        🔍 COMMON SOLUTIONS:
        1. Clear browser cache & cookies
        2. Try different browser/device
        3. Check internet connection
        4. Disable ad blockers
        
        📊 SYSTEM STATUS: All services operational
        
        Still stuck? Type 'admin help' for human assistance.`;
    }
    
    if (lowerMessage.includes('win') || lowerMessage.includes('match') || lowerMessage.includes('game')) {
        return `🎮 GAMING INTELLIGENCE ACTIVATED:
        
        🏆 WINNING STRATEGIES:
        - Start with small bets (KSh 100-200)
        - Play games you're skilled at
        - Study opponent patterns
        - Take clear result screenshots
        
        📊 YOUR STATS: Balance KSh ${userBalance}
        
        Ready to dominate? Go to Quick Matches!`;
    }
    
    // Increment failed attempts
    failedAttempts++;
    localStorage.setItem('failedAttempts', failedAttempts.toString());
    
    // Escalate to admin after max attempts
    if (failedAttempts >= maxAttempts) {
        sendToAdmin(message);
        return `Hey, I want to make sure you get the best help possible. Let me connect you with my supervisor who can handle more complex issues.
        
        📞 **Direct Admin Line:** +254729237059
        📧 **Your case has been forwarded** to our senior support team
        
        You should hear back within 15 minutes. Is there anything else I can help with while you wait?`;
    }
    
    return responses.default.response;
}

function sendToAdmin(userMessage) {
    // Send escalation notification
    fetch('/escalate_support', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            user: '{{ session.username }}',
            message: userMessage,
            timestamp: new Date().toISOString()
        })
    }).catch(console.error);
}

// Auto-scroll to bottom on load
window.onload = function() {
    document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
};
</script>

<style>
.user-message {
    text-align: right;
    background: rgba(0,255,136,0.1) !important;
}
.bot-message {
    text-align: left;
    background: rgba(255,255,255,0.1) !important;
}
</style>
{% endblock %}