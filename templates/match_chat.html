{% extends "base.html" %}

{% block content %}
<div class="chat-header-card">
    <div class="chat-title">
        <h1><svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M20,2H4A2,2 0 0,0 2,4V22L6,18H20A2,2 0 0,0 22,16V4C22,2.89 21.1,2 20,2Z"/></svg> MATCH CHAT</h1>
        <p>Coordinate • Share room details • Stay connected</p>
    </div>
    <div class="match-info">
        <span class="match-badge"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M7.5,4A5.5,5.5 0 0,0 2,9.5C2,10 2,10.5 2.1,11H6.1L10.5,9L15,11H22.9C23,10.5 23,10 23,9.5A5.5,5.5 0 0,0 17.5,4A5.5,5.5 0 0,0 12,7A5.5,5.5 0 0,0 7.5,4M7.5,6A3.5,3.5 0 0,1 11,9.5A3.5,3.5 0 0,1 7.5,13A3.5,3.5 0 0,1 4,9.5A3.5,3.5 0 0,1 7.5,6M16.5,6A3.5,3.5 0 0,1 20,9.5A3.5,3.5 0 0,1 16.5,13A3.5,3.5 0 0,1 13,9.5A3.5,3.5 0 0,1 16.5,6Z"/></svg> Live Match</span>
        <span class="status-badge active">Active</span>
    </div>
</div>

<div class="chat-main-container">
    <div class="chat-window">
        <div class="messages-container" id="chatMessages">
            {% for message in messages %}
            <div class="message {% if message[0] == session.username %}own-message{% else %}other-message{% endif %}">
                <div class="message-header">
                    <span class="username">{{ message[0] }}</span>
                    <span class="timestamp">{{ message[2] }}</span>
                </div>
                <div class="message-content">{{ message[1] }}</div>
            </div>
            {% else %}
            <div class="empty-chat">
                <div class="empty-icon">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor"><path d="M12,3C17.5,3 22,6.58 22,11C22,15.42 17.5,19 12,19C10.76,19 9.57,18.82 8.47,18.5C5.55,21 2,21 2,21C4.33,18.67 4.7,17.1 4.75,16.5C3.05,15.07 2,13.13 2,11C2,6.58 6.5,3 12,3Z"/></svg>
                </div>
                <h3>Start the conversation!</h3>
                <p>Share room IDs, coordinate gameplay, or just say hi</p>
            </div>
            {% endfor %}
        </div>
        
        <div class="chat-input-container">
            <input type="text" id="messageInput" placeholder="Type your message..." class="message-input">
            <button onclick="sendMessage()" class="send-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/></svg>
            </button>
        </div>
    </div>
</div>

<div class="quick-actions">
    <div class="quick-messages">
        <h3><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M9,22A1,1 0 0,1 8,21V18H4A2,2 0 0,1 2,16V4C2,2.89 2.9,2 4,2H20A2,2 0 0,0 22,4V16A2,2 0 0,0 20,18H13.9L10.2,21.71C10,21.9 9.75,22 9.5,22V22H9Z"/></svg> Quick Messages</h3>
        <div class="quick-buttons">
            <button onclick="sendQuickMessage('Ready to play!')" class="quick-btn ready">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8,5.14V19.14L19,12.14L8,5.14Z"/></svg>
                Ready!
            </button>
            <button onclick="sendQuickMessage('Share room ID please')" class="quick-btn room">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z"/></svg>
                Room ID?
            </button>
            <button onclick="sendQuickMessage('Good luck!')" class="quick-btn luck">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2L13.09,8.26L22,9L13.09,9.74L12,16L10.91,9.74L2,9L10.91,8.26L12,2Z"/></svg>
                Good luck!
            </button>
            <button onclick="sendQuickMessage('GG! Well played')" class="quick-btn gg">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M23,12L20.56,9.22L20.9,5.54L17.29,4.72L15.4,1.54L12,3L8.6,1.54L6.71,4.72L3.1,5.53L3.44,9.21L1,12L3.44,14.78L3.1,18.47L6.71,19.29L8.6,22.47L12,21L15.4,22.46L17.29,19.28L20.9,18.46L20.56,14.78L23,12M10,17L6,13L7.41,11.59L10,14.17L16.59,7.58L18,9L10,17Z"/></svg>
                GG!
            </button>
        </div>
    </div>
    
    <div class="action-buttons">
        <a href="/match_lobby/{{ match_id }}" class="action-btn primary">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19,19H5V5H19M19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M13.96,12.29L11.21,15.83L9.25,13.47L6.5,17H17.5L13.96,12.29Z"/></svg>
            Back to Lobby
        </a>
        <a href="/matches" class="action-btn secondary">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z"/></svg>
            All Matches
        </a>
    </div>
</div>

<script>
let lastMessageCount = 0;

function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (message) {
        const sendBtn = document.querySelector('.send-btn');
        sendBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12,4V2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M18,12A6,6 0 0,1 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6A6,6 0 0,1 18,12Z"/></svg>';
        sendBtn.disabled = true;
        
        fetch('/send_match_message', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({match_id: {{ match_id }}, message: message})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                input.value = '';
                loadMessages();
            }
        })
        .finally(() => {
            sendBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/></svg>';
            sendBtn.disabled = false;
        });
    }
}

function sendQuickMessage(message) {
    document.getElementById('messageInput').value = message;
    sendMessage();
}

function loadMessages() {
    fetch('/get_match_messages/{{ match_id }}')
    .then(response => response.json())
    .then(data => {
        const chatDiv = document.getElementById('chatMessages');
        lastMessageCount = data.messages.length;
        
        chatDiv.innerHTML = '';
        
        if (data.messages.length === 0) {
            chatDiv.innerHTML = `
                <div class="empty-chat">
                    <div class="empty-icon">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor"><path d="M12,3C17.5,3 22,6.58 22,11C22,15.42 17.5,19 12,19C10.76,19 9.57,18.82 8.47,18.5C5.55,21 2,21 2,21C4.33,18.67 4.7,17.1 4.75,16.5C3.05,15.07 2,13.13 2,11C2,6.58 6.5,3 12,3Z"/></svg>
                    </div>
                    <h3>Start the conversation!</h3>
                    <p>Share room IDs, coordinate gameplay, or just say hi</p>
                </div>
            `;
        } else {
            data.messages.forEach(msg => {
                const isCurrentUser = msg.username === '{{ session.username }}';
                const msgDiv = document.createElement('div');
                msgDiv.className = `message ${isCurrentUser ? 'own-message' : 'other-message'}`;
                
                msgDiv.innerHTML = `
                    <div class="message-header">
                        <span class="username">${isCurrentUser ? 'You' : msg.username}</span>
                        <span class="timestamp">${formatTime(msg.time)}</span>
                    </div>
                    <div class="message-content">${msg.message}</div>
                `;
                
                chatDiv.appendChild(msgDiv);
            });
        }
        
        chatDiv.scrollTop = chatDiv.scrollHeight;
    });
}

function formatTime(timeStr) {
    try {
        const date = new Date(timeStr);
        return date.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit'
        });
    } catch {
        return 'now';
    }
}

document.getElementById('messageInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
    }
});

document.getElementById('messageInput').focus();
loadMessages();
setInterval(loadMessages, 3000);

// Add modern chat styles
const style = document.createElement('style');
style.textContent = `
    .chat-header-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%, #f093fb 200%);
        color: white;
        padding: 2rem;
        border-radius: 20px;
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        position: relative;
        overflow: hidden;
    }
    .chat-header-card::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        animation: float 6s ease-in-out infinite;
    }
    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-10px) rotate(5deg); }
    }
    .chat-title h1 { 
        margin: 0; 
        font-size: 2rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .chat-title p { margin: 0.5rem 0 0 0; opacity: 0.9; }
    .match-badge, .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        margin-left: 0.5rem;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        backdrop-filter: blur(10px);
    }
    .match-badge {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
    }
    .status-badge.active {
        background: linear-gradient(45deg, #00ff88, #00cc6a);
        color: white;
        font-weight: 600;
        box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0%, 100% { box-shadow: 0 0 20px rgba(0, 255, 136, 0.3); }
        50% { box-shadow: 0 0 30px rgba(0, 255, 136, 0.6); }
    }
    .chat-main-container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-bottom: 1rem;
    }
    .chat-window {
        height: 500px;
        display: flex;
        flex-direction: column;
    }
    .messages-container {
        flex: 1;
        padding: 1.5rem;
        overflow-y: auto;
        background: #f8f9fa;
    }
    .message {
        margin-bottom: 1rem;
        max-width: 80%;
        animation: fadeIn 0.3s ease;
    }
    .own-message {
        margin-left: auto;
    }
    .other-message {
        margin-right: auto;
    }
    .message-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.3rem;
        font-size: 0.8rem;
    }
    .username {
        font-weight: bold;
        color: #667eea;
    }
    .timestamp {
        color: #999;
    }
    .message-content {
        padding: 1rem;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        word-wrap: break-word;
    }
    .own-message .message-content {
        background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    .other-message .message-content {
        background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
        color: #333;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    .empty-chat {
        text-align: center;
        color: #999;
        margin-top: 100px;
    }
    .empty-icon {
        margin-bottom: 1rem;
        opacity: 0.6;
        animation: bounce 2s infinite;
    }
    .empty-icon svg {
        color: #667eea;
    }
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-10px); }
        60% { transform: translateY(-5px); }
    }
    .chat-input-container {
        padding: 1.5rem;
        background: white;
        border-top: 1px solid #eee;
        display: flex;
        gap: 1rem;
    }
    .message-input {
        flex: 1;
        padding: 1rem;
        border: 2px solid #eee;
        border-radius: 25px;
        font-size: 1rem;
        outline: none;
        transition: border-color 0.3s;
    }
    .message-input:focus {
        border-color: #667eea;
    }
    .send-btn {
        background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
        color: white;
        border: none;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    .send-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .quick-actions {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1rem;
        margin-top: 1rem;
    }
    .quick-messages {
        background: linear-gradient(135deg, #ffecd2, #fcb69f, #ff9a9e);
        padding: 1.5rem;
        border-radius: 20px;
        box-shadow: 0 8px 25px rgba(255, 183, 159, 0.3);
        position: relative;
        overflow: hidden;
    }
    .quick-messages::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        animation: float 8s ease-in-out infinite reverse;
    }
    .quick-messages h3 {
        margin: 0 0 1rem 0;
        color: #333;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        position: relative;
        z-index: 1;
    }
    .quick-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.5rem;
        position: relative;
        z-index: 1;
    }
    .quick-btn {
        border: none;
        padding: 0.8rem 1rem;
        border-radius: 15px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .quick-btn.ready {
        background: linear-gradient(45deg, #00ff88, #00cc6a);
        color: white;
    }
    .quick-btn.room {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
    }
    .quick-btn.luck {
        background: linear-gradient(45deg, #ffd700, #ffed4e);
        color: #333;
    }
    .quick-btn.gg {
        background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        color: white;
    }
    .quick-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }
    .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    .action-btn {
        padding: 1rem;
        border-radius: 15px;
        text-decoration: none;
        text-align: center;
        font-weight: bold;
        transition: transform 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .action-btn.primary {
        background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    .action-btn.secondary {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        color: #495057;
        border: 1px solid #dee2e6;
    }
    .action-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @media (max-width: 768px) {
        .chat-header-card {
            flex-direction: column;
            text-align: center;
            padding: 1.5rem;
        }
        .match-info {
            margin-top: 1rem;
        }
        .quick-actions {
            grid-template-columns: 1fr;
        }
        .chat-window {
            height: 350px;
        }
        .messages-container {
            padding: 1rem;
        }
        .message {
            max-width: 90%;
        }
        .quick-buttons {
            grid-template-columns: repeat(2, 1fr);
        }
        .quick-btn {
            padding: 0.6rem 0.8rem;
            font-size: 0.8rem;
        }
        .action-btn {
            padding: 0.8rem;
            font-size: 0.9rem;
        }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}