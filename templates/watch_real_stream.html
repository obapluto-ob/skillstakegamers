{% extends "base.html" %}

{% block content %}
<div class="card">
    <h1><span style="color: #dc3545; font-size: 0.8em;">●</span> {{ stream[4] }}</h1>
    <p>Streamed by: <strong>{{ stream[10] }}</strong></p>
</div>

<!-- Full Screen Stream Container -->
<div style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 1000;">
<style>
/* Hide navigation when streaming */
nav, .navbar, header, .header { display: none !important; }
body { overflow: hidden !important; }
</style>
    <div id="streamContainer" style="width: 100%; height: 100%; position: relative;">
        <video id="streamVideo" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover;"></video>
                
                <!-- Stream Status Overlay -->
                <div id="streamStatus" style="position: absolute; top: 15px; left: 15px; background: #dc3545; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-weight: bold;">
                    <span style="color: #fff;">●</span> CONNECTING...
                </div>
                
                <!-- Viewer Count -->
                <div id="viewerDisplay" style="position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.8); color: white; padding: 0.5rem 1rem; border-radius: 15px;">
                    <span style="color: #00ff88;">◉</span> 0 viewers
                </div>
                
                <!-- Connection Quality -->
                <div id="qualityIndicator" style="position: absolute; bottom: 15px; right: 15px; background: rgba(0,0,0,0.8); color: #00ff88; padding: 0.5rem 1rem; border-radius: 15px; font-size: 0.9rem;">
                    Quality: HD
                </div>
        
        <!-- Exit Stream Button -->
        <button onclick="exitStream()" style="position: absolute; top: 20px; left: 20px; background: rgba(220,53,69,0.9); border: none; padding: 10px 15px; border-radius: 8px; color: white; cursor: pointer; z-index: 10;">
            ← Exit Stream
        </button>
        
        <!-- Stream Controls -->
        <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 1rem; align-items: center; background: rgba(0,0,0,0.8); padding: 15px 20px; border-radius: 15px;">
            <button onclick="toggleMute()" id="muteBtn" style="background: rgba(255,255,255,0.2); border: none; padding: 8px 12px; border-radius: 6px; color: white; cursor: pointer;"><span style="font-size: 1.2em;">♪</span></button>
            <input type="range" id="volumeSlider" min="0" max="100" value="100" style="width: 100px;">
            <button onclick="toggleChat()" id="chatToggle" style="background: rgba(0,255,136,0.8); border: none; padding: 8px 12px; border-radius: 6px; color: white; cursor: pointer;"><span style="color: #fff;">◈</span> Chat</button>
        </div>
    </div>
    
    <!-- Chat Overlay -->
    <div id="chatOverlay" style="position: absolute; top: 80px; right: 20px; width: 350px; height: 500px; background: rgba(0,0,0,0.9); border-radius: 15px; padding: 20px; display: none; z-index: 10;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h4 style="color: white; margin: 0;"><span style="color: #00ff88;">◈</span> Live Chat</h4>
            <button onclick="toggleChat()" style="background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer;">×</button>
        </div>
        
        <div id="chatMessages" style="height: 350px; overflow-y: auto; margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; color: white;">
            <div style="color: #666; text-align: center; padding: 2rem;">
                Chat will appear here when viewers start talking...
            </div>
        </div>
        
        <div style="display: flex; gap: 8px;">
            <input type="text" id="chatInput" placeholder="Type a message..." style="flex: 1; padding: 10px; border-radius: 8px; border: none; background: rgba(255,255,255,0.2); color: white;">
            <button onclick="sendChatMessage()" style="background: #00ff88; border: none; padding: 10px 15px; border-radius: 8px; color: black; cursor: pointer; font-weight: bold;">Send</button>
        </div>
        
        <!-- Stream Info -->
        <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.9rem; color: white;">
                <div><strong>Status:</strong> <span id="streamStatusText">Live</span></div>
                <div><strong>Quality:</strong> <span id="streamQuality">HD</span></div>
                <div><strong>Viewers:</strong> <span id="viewerCount">0</span></div>
                <div><strong>Duration:</strong> <span id="streamDuration">0:00</span></div>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='streaming.js') }}"></script>
<script src="{{ url_for('static', filename='webrtc.js') }}"></script>
<script>
let streamViewer;
let isMuted = false;
let startTime = Date.now();

// Initialize stream viewer
document.addEventListener('DOMContentLoaded', async () => {
    // Restore camera state from localStorage
    const cameraWasOn = localStorage.getItem('cameraState') === 'on';
    // Check if stream is actually live
    fetch('/get_stream_url/{{ stream_id }}')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.status === 'live') {
                // Stream is live - show actual streaming interface
                document.getElementById('streamStatus').innerHTML = '<span style="color: #fff;">●</span> LIVE';
                document.getElementById('streamStatus').style.background = '#dc3545';
                
                // Show actual streaming interface with camera/screen sharing
                document.getElementById('streamContainer').innerHTML = `
                    <div style="position: relative; width: 100%; height: 100%; background: #000;">
                        <!-- Real Video Stream Display -->
                        <video id="remoteVideo" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover; background: #1a1a1a; display: ${data.is_owner ? 'none' : 'block'};"></video>
                        
                        <!-- Local Stream (Owner Only) -->
                        <video id="localVideo" autoplay playsinline muted style="width: 100%; height: 100%; object-fit: cover; display: ${data.is_owner ? 'block' : 'none'};"></video>
                        
                        <!-- Stream Controls Overlay -->
                        <div style="position: absolute; bottom: 20px; left: 20px; display: flex; gap: 10px; ${data.is_owner ? 'display: flex' : 'display: none'};">
                            <button onclick="startCamera()" id="cameraBtn" style="background: rgba(0,255,136,0.8); border: none; padding: 10px 15px; border-radius: 8px; color: white; cursor: pointer;"><span style="font-size: 1.1em;">◉</span> Camera</button>
                            <button onclick="startScreenShare()" id="screenBtn" style="background: rgba(102,126,234,0.8); border: none; padding: 10px 15px; border-radius: 8px; color: white; cursor: pointer;"><span style="font-size: 1.1em;">▣</span> Screen</button>
                            <button onclick="stopStreaming()" id="stopBtn" style="background: rgba(220,53,69,0.8); border: none; padding: 10px 15px; border-radius: 8px; color: white; cursor: pointer;"><span style="font-size: 1.1em;">◼</span> Stop</button>
                        </div>
                        
                        <!-- Admin Watch Controls -->
                        <div style="position: absolute; bottom: 20px; left: 20px; display: ${data.is_owner ? 'none' : 'flex'}; gap: 10px;">
                            <div style="background: rgba(0,0,0,0.8); padding: 10px 15px; border-radius: 8px; color: white;">
                                <span style="color: #00ff88;">◉</span> Watching Live Stream
                            </div>
                        </div>
                        
                        <!-- Stream Status -->
                        <div style="position: absolute; top: 20px; left: 20px; background: rgba(220,53,69,0.9); padding: 8px 15px; border-radius: 20px; color: white; font-weight: bold;">
                            <span style="color: #fff;">●</span> LIVE
                        </div>
                        
                        <!-- Viewer Count -->
                        <div id="liveViewerCount" style="position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.8); padding: 8px 15px; border-radius: 15px; color: white; z-index: 15;">
                            <span style="color: #00ff88;">◉</span> 0 viewers
                        </div>
                        
                        <!-- Earnings Display (Only for Stream Owner) -->
                        <div id="earningsDisplay" style="position: absolute; top: 70px; right: 20px; background: rgba(0,255,136,0.9); padding: 8px 15px; border-radius: 15px; color: white; font-size: 0.9rem; font-weight: bold; z-index: 15; display: ${data.is_owner ? 'block' : 'none'};">
                            <span style="color: #fff;">◆</span> Earning: KSh<span id="earningsAmount">0.00</span>
                        </div>
                        

                        
                        <!-- Live Chat Overlay (Enhanced TikTok Style) -->
                        <div id="liveChatOverlay" style="position: absolute; bottom: 80px; right: 20px; width: 320px; height: 400px; z-index: 15; display: block;">
                            <!-- Chat Header -->
                            <div style="display: flex; justify-content: between; align-items: center; padding: 8px 12px; background: rgba(0,0,0,0.8); border-radius: 15px 15px 0 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span style="color: white; font-weight: bold; font-size: 14px;">💬 Live Chat</span>

                            </div>
                            
                            <!-- Scrollable Chat Messages (Transparent) -->
                            <div id="liveChatMessages" style="height: 280px; overflow-y: auto; padding: 8px; background: rgba(0,0,0,0.2); backdrop-filter: blur(5px); scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.3) transparent;">
                                <!-- Messages appear here -->
                            </div>
                            
                            <!-- Chat Input with @ mentions -->
                            <div style="display: flex; gap: 8px; align-items: center; padding: 8px; background: rgba(0,0,0,0.8); border-radius: 0 0 15px 15px;">
                                <input type="text" id="liveChatInput" placeholder="Say something... (@username to mention)" style="flex: 1; padding: 10px 12px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 13px; backdrop-filter: blur(10px);">
                                <button onclick="sendLiveChat()" style="width: 35px; height: 35px; border-radius: 50%; background: linear-gradient(45deg, #ff6b6b, #4ecdc4); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s; border: none;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                                    <span style="color: white; font-size: 14px; font-weight: bold;">➤</span>
                                </button>
                            </div>
                            
                            <!-- @ Mention Suggestions -->
                            <div id="mentionSuggestions" style="position: absolute; bottom: 60px; left: 8px; right: 8px; background: rgba(0,0,0,0.9); border-radius: 8px; max-height: 120px; overflow-y: auto; display: none; z-index: 20;"></div>
                        </div>
                        
                        <!-- Bottom Right Action Buttons -->
                        <div style="position: absolute; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 25;">
                            <button onclick="shareStream()" style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(45deg, #4ecdc4, #44a08d); border: none; color: white; font-size: 18px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                                ↗
                            </button>
                            <button onclick="toggleGifts()" style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(45deg, #ff6b6b, #ffd93d); border: none; color: white; font-size: 18px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: transform 0.2s; display: ${data.is_owner ? 'none' : 'block'};" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                                ♦
                            </button>
                        </div>
                        
                        <!-- Gift Panel -->
                        <div id="giftPanel" style="position: absolute; bottom: 90px; right: 20px; width: 300px; height: 400px; background: rgba(0,0,0,0.3); backdrop-filter: blur(10px); border-radius: 15px; padding: 15px; display: none; z-index: 20; border: 1px solid rgba(255,255,255,0.1);">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                                <h4 style="color: white; margin: 0;">♦ Send Gift</h4>
                                <button onclick="toggleGifts()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer;">×</button>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                <button onclick="sendGift(50, '♥')" style="background: linear-gradient(45deg, #ff6b6b, #ff8e8e); border: none; padding: 15px; border-radius: 10px; color: white; cursor: pointer;">
                                    <div style="font-size: 24px;">♥</div>
                                    <div style="font-size: 12px;">Heart</div>
                                    <div style="font-weight: bold;">KSh 50</div>
                                </button>
                                
                                <button onclick="sendGift(100, '♦')" style="background: linear-gradient(45deg, #4ecdc4, #44a08d); border: none; padding: 15px; border-radius: 10px; color: white; cursor: pointer;">
                                    <div style="font-size: 24px;">♦</div>
                                    <div style="font-size: 12px;">Diamond</div>
                                    <div style="font-weight: bold;">KSh 100</div>
                                </button>
                                
                                <button onclick="sendGift(250, '★')" style="background: linear-gradient(45deg, #ffd93d, #ffb347); border: none; padding: 15px; border-radius: 10px; color: white; cursor: pointer;">
                                    <div style="font-size: 24px;">★</div>
                                    <div style="font-size: 12px;">Star</div>
                                    <div style="font-weight: bold;">KSh 250</div>
                                </button>
                                
                                <button onclick="sendGift(500, '▲')" style="background: linear-gradient(45deg, #667eea, #764ba2); border: none; padding: 15px; border-radius: 10px; color: white; cursor: pointer;">
                                    <div style="font-size: 24px;">▲</div>
                                    <div style="font-size: 12px;">Rocket</div>
                                    <div style="font-weight: bold;">KSh 500</div>
                                </button>
                                
                                <button onclick="sendGift(1000, '◆')" style="background: linear-gradient(45deg, #ff6b6b, #ffd93d); border: none; padding: 15px; border-radius: 10px; color: white; cursor: pointer;">
                                    <div style="font-size: 24px;">◆</div>
                                    <div style="font-size: 12px;">Gem</div>
                                    <div style="font-weight: bold;">KSh 1000</div>
                                </button>
                                
                                <button onclick="sendGift(2000, '✦')" style="background: linear-gradient(45deg, #ff6b6b, #667eea); border: none; padding: 15px; border-radius: 10px; color: white; cursor: pointer;">
                                    <div style="font-size: 24px;">✦</div>
                                    <div style="font-size: 12px;">Burst</div>
                                    <div style="font-weight: bold;">KSh 2000</div>
                                </button>
                            </div>
                            
                            <div style="text-align: center; color: #ccc; font-size: 12px;">
                                Your Balance: KSh <span id="userBalance" data-balance="{{ session.balance or 0 }}">{{ session.balance or 0 }}</span>
                            </div>
                        </div>
                        
                        <!-- Share Panel -->
                        <div id="sharePanel" style="position: absolute; top: 120px; right: 20px; width: 280px; background: rgba(0,0,0,0.9); border-radius: 15px; padding: 15px; display: none; z-index: 20;">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                                <h4 style="color: white; margin: 0;">↗ Share Stream</h4>
                                <button onclick="toggleShare()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer;">×</button>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                <button onclick="shareToWhatsApp()" style="background: #25d366; border: none; padding: 10px; border-radius: 8px; color: white; cursor: pointer;">
                                    <div>W WhatsApp</div>
                                </button>
                                
                                <button onclick="shareToTelegram()" style="background: #0088cc; border: none; padding: 10px; border-radius: 8px; color: white; cursor: pointer;">
                                    <div>T Telegram</div>
                                </button>
                                
                                <button onclick="shareToFacebook()" style="background: #1877f2; border: none; padding: 10px; border-radius: 8px; color: white; cursor: pointer;">
                                    <div>F Facebook</div>
                                </button>
                                
                                <button onclick="shareToInstagram()" style="background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); border: none; padding: 10px; border-radius: 8px; color: white; cursor: pointer;">
                                    <div>I Instagram</div>
                                </button>
                            </div>
                            
                            <div style="margin-bottom: 10px;">
                                <input type="text" id="shareLink" value="{{ request.url }}" readonly style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc; background: rgba(255,255,255,0.1); color: white; font-size: 12px;">
                            </div>
                            
                            <button onclick="copyShareLink()" style="width: 100%; background: #4ecdc4; border: none; padding: 8px; border-radius: 5px; color: white; cursor: pointer;">
                                ⧉ Copy Link
                            </button>
                        </div>
                        
                        <!-- Gift Animations Overlay -->
                        <div id="giftAnimations" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 25;"></div>
                        
                        <!-- Big Gift Celebration -->
                        <div id="bigGiftCelebration" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,215,0,0.1); display: none; z-index: 30; pointer-events: none;">
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: white;">
                                <div id="bigGiftIcon" style="font-size: 120px; margin-bottom: 20px;"></div>
                                <div id="bigGiftText" style="font-size: 24px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);"></div>
                                <div id="bigGiftCheer" style="font-size: 18px; margin-top: 10px; color: #ffd700;"></div>
                            </div>
                        </div>
                    </div>
                `;
                
                updateStreamDuration();
                loadChatMessages();
                
                // Auto-restore camera if it was on before refresh
                if (cameraWasOn) {
                    setTimeout(() => {
                        startCamera();
                    }, 1000);
                }
                
                // Start earnings counter (only for stream owner)
                if (data.is_owner) {
                    startEarningsCounter();
                }
                
                // Auto-refresh live chat every 2 seconds
                setInterval(() => {
                    loadLiveChat();
                }, 2000);
                
                // Initialize real video streaming
                window.realStream = initRealStreaming({{ stream_id }}, data.is_owner);
                
                // Clear any loading/refresh text
                const loadingElements = document.querySelectorAll('.loading, [data-loading]');
                loadingElements.forEach(el => el.remove());
                
                // Remove any refresh indicators
                document.body.classList.remove('refreshing', 'loading');
                
                // Hide any loading overlays
                const overlays = document.querySelectorAll('.loading-overlay, .refresh-indicator');
                overlays.forEach(overlay => overlay.style.display = 'none');
                
                // Show welcome message and load initial chat
                setTimeout(() => {
                    showWelcomeChat();
                    loadLiveChat();
                }, 500);
            } else {
                // Stream is offline
                document.getElementById('streamStatus').innerHTML = '<span style="color: #fff;">◯</span> OFFLINE';
                document.getElementById('streamStatus').style.background = '#dc3545';
                document.getElementById('streamStatusText').textContent = 'Offline';
                
                document.getElementById('streamContainer').innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #1a1a1a; color: white; text-align: center;">
                        <div>
                            <h3><span style="color: #666;">▣</span> Stream Ended</h3>
                            <p>This stream is no longer broadcasting</p>
                            <div style="margin: 1rem 0; padding: 1rem; background: rgba(220,53,69,0.1); border-radius: 10px;">
                                <strong>Stream was automatically ended</strong><br>
                                Streams end after 4 hours of inactivity
                            </div>
                            <button onclick="window.location.href='/live_streams'" class="btn btn-primary">View Active Streams</button>
                        </div>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Stream check failed:', error);
            document.getElementById('streamStatus').innerHTML = '<span style="color: #fff;">⚠</span> ERROR';
            document.getElementById('streamStatus').style.background = '#dc3545';
        });
});

function updateStreamDuration() {
    setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('streamDuration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
}

function exitStream() {
    // If user is stream owner, ask if they want to end the stream
    if ({{ 'true' if session.user_id == stream[1] else 'false' }}) {
        if (confirm('Do you want to end your stream?')) {
            stopStreaming();
        } else {
            window.location.href = '/live_streams';
        }
    } else {
        window.location.href = '/live_streams';
    }
}

function toggleChat() {
    const chatOverlay = document.getElementById('chatOverlay');
    const isVisible = chatOverlay.style.display !== 'none';
    chatOverlay.style.display = isVisible ? 'none' : 'block';
    
    const toggleBtn = document.getElementById('chatToggle');
    toggleBtn.innerHTML = isVisible ? '<span style="color: #fff;">◈</span> Chat' : '<span style="color: #fff;">◈</span> Hide';
}

function toggleMute() {
    const video = document.getElementById('streamVideo');
    const btn = document.getElementById('muteBtn');
    
    isMuted = !isMuted;
    video.muted = isMuted;
    
    btn.innerHTML = isMuted ? '<span style="font-size: 1.2em;">✖</span>' : '<span style="font-size: 1.2em;">♪</span>';
}

// Volume control
document.getElementById('volumeSlider').addEventListener('input', (e) => {
    const video = document.getElementById('streamVideo');
    video.volume = e.target.value / 100;
});

// Chat functionality
function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (message) {
        // Send to server
        fetch('/send_stream_chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                stream_id: parseInt('{{ stream_id }}'),
                message: message
            })
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                input.value = '';
                loadChatMessages();
            } else {
                alert('Failed to send message: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(err => {
            console.error('Chat send failed:', err);
            alert('Failed to send message');
        });
    }
}

function loadChatMessages() {
    fetch('/get_stream_chat/{{ stream_id }}')
        .then(response => response.json())
        .then(data => {
            const chatDiv = document.getElementById('chatMessages');
            if (data.messages && data.messages.length > 0) {
                chatDiv.innerHTML = data.messages.map(msg => 
                    `<div style="margin-bottom: 0.5rem;">
                        <strong style="color: #00ff88;">${msg.username}:</strong> 
                        <span>${msg.message}</span>
                    </div>`
                ).join('');
                chatDiv.scrollTop = chatDiv.scrollHeight;
            }
        })
        .catch(err => console.log('Chat load failed:', err));
}



// Camera and Screen Sharing Functions
let cameraStream = null;
let screenStream = null;
let isStreaming = false;

async function startCamera() {
    try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ 
            video: { width: 1280, height: 720 }, 
            audio: true 
        });
        
        const cameraVideo = document.getElementById('cameraStream');
        const mainVideo = document.getElementById('mainStream');
        
        if (cameraVideo) {
            cameraVideo.srcObject = cameraStream;
            cameraVideo.style.display = 'block';
            if (mainVideo) mainVideo.style.display = 'none';
            document.getElementById('cameraBtn').innerHTML = '<span style="font-size: 1.1em;">◉</span> Camera ON';
            document.getElementById('cameraBtn').style.background = 'rgba(0,255,136,1)';
            localStorage.setItem('cameraState', 'on');
        }
    } catch (err) {
        alert('Camera access denied or not available');
        console.error('Camera error:', err);
    }
}

async function startScreenShare() {
    try {
        screenStream = await navigator.mediaDevices.getDisplayMedia({ 
            video: { width: 1920, height: 1080 }, 
            audio: true 
        });
        
        const mainVideo = document.getElementById('mainStream');
        if (mainVideo) {
            mainVideo.srcObject = screenStream;
            document.getElementById('screenBtn').innerHTML = '<span style="font-size: 1.1em;">▣</span> Sharing';
            document.getElementById('screenBtn').style.background = 'rgba(102,126,234,1)';
            isStreaming = true;
        }
        
        // Handle screen share end
        screenStream.getVideoTracks()[0].onended = () => {
            stopScreenShare();
        };
    } catch (err) {
        alert('Screen sharing cancelled or not supported');
        console.error('Screen share error:', err);
    }
}

function stopScreenShare() {
    if (screenStream) {
        screenStream.getTracks().forEach(track => track.stop());
        screenStream = null;
        document.getElementById('screenBtn').innerHTML = '<span style="font-size: 1.1em;">▣</span> Screen';
        document.getElementById('screenBtn').style.background = 'rgba(102,126,234,0.8)';
        
        const mainVideo = document.getElementById('mainStream');
        if (mainVideo) {
            mainVideo.srcObject = null;
        }
    }
}

function stopStreaming() {
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
        const cameraVideo = document.getElementById('cameraStream');
        const mainVideo = document.getElementById('mainStream');
        if (cameraVideo) cameraVideo.style.display = 'none';
        if (mainVideo) mainVideo.style.display = 'block';
        const cameraBtn = document.getElementById('cameraBtn');
        if (cameraBtn) {
            cameraBtn.innerHTML = '<span style="font-size: 1.1em;">◉</span> Camera';
            cameraBtn.style.background = 'rgba(0,255,136,0.8)';
        }
        localStorage.setItem('cameraState', 'off');
    }
    
    stopScreenShare();
    isStreaming = false;
    
    // Save replay before ending
    const duration = Math.floor((Date.now() - startTime) / 1000 / 60); // minutes
    const viewersPeak = parseInt(document.getElementById('liveViewerCount')?.textContent?.match(/\d+/)?.[0] || '0');
    
    fetch('/save_stream_replay', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            stream_id: {{ stream_id }},
            duration: duration,
            viewers_peak: viewersPeak
        })
    });
    
    // End stream on server
    fetch('/stop_stream/{{ stream_id }}', { 
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show earnings in a nice format
            const earnings = data.earnings || 0;
            const message = data.message || `Stream ended! You earned KSh ${earnings}`;
            
            // Create a nice popup instead of alert
            const popup = document.createElement('div');
            popup.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 15px; text-align: center; max-width: 400px;">
                        <h3 style="color: #28a745; margin-bottom: 20px;">🎉 Stream Ended Successfully!</h3>
                        <p style="font-size: 18px; margin-bottom: 15px;">You earned <strong style="color: #28a745;">KSh ${earnings}</strong></p>
                        <p style="color: #666; margin-bottom: 20px;">Duration: ${duration} minutes</p>
                        <button onclick="window.location.href='/live_streams'" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">View Live Streams</button>
                    </div>
                </div>
            `;
            document.body.appendChild(popup);
        } else {
            alert('Error ending stream: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('End stream error:', err);
        alert('Error ending stream. Please try again.');
    });
}

// Update real viewer count every 5 seconds
setInterval(() => {
    // Update real viewer count from database
    fetch(`/stream_viewers/{{ stream_id }}`)
        .then(response => response.json())
        .then(data => {
            if (data.count !== undefined) {
                const viewerCountEl = document.getElementById('viewerCount');
                const viewerDisplayEl = document.getElementById('viewerDisplay');
                const liveViewerCountEl = document.getElementById('liveViewerCount');
                
                if (viewerCountEl) viewerCountEl.textContent = data.count;
                if (viewerDisplayEl) viewerDisplayEl.innerHTML = `<span style="color: #00ff88;">◉</span> ${data.count} viewers`;
                if (liveViewerCountEl) liveViewerCountEl.innerHTML = `<span style="color: #00ff88;">◉</span> ${data.count} viewers`;
            }
        })
        .catch(err => console.log('Viewer update failed:', err));
    
    // Reload chat messages
    loadChatMessages();
}, 3000);

// Connection quality monitoring
setInterval(() => {
    if (streamViewer && streamViewer.peerConnection) {
        streamViewer.peerConnection.getStats().then(stats => {
            stats.forEach(report => {
                if (report.type === 'inbound-rtp' && report.mediaType === 'video') {
                    const quality = report.bytesReceived > 100000 ? 'HD' : 'SD';
                    document.getElementById('qualityIndicator').innerHTML = `Quality: ${quality}`;
                    document.getElementById('streamQuality').textContent = `${quality} 1080p`;
                }
            });
        }).catch(err => {});
    }
}, 3000);

// Earnings counter function - Server-based
function startEarningsCounter() {
    // Get current earnings from server
    fetch('/get_stream_earnings/{{ stream_id }}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('earningsAmount').textContent = data.earnings.toFixed(0);
            }
        });
    
    setInterval(() => {
        const viewerCount = parseInt(document.getElementById('liveViewerCount')?.textContent?.match(/\d+/)?.[0] || '0');
        if (viewerCount > 0) {
            // Update earnings on server
            fetch('/update_stream_earnings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    stream_id: {{ stream_id }},
                    viewers: viewerCount
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('earningsAmount').textContent = data.total_earnings.toFixed(0);
                }
            });
        }
    }, 5000);
}

// Fix all button handlers
function fixButtonHandlers() {
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });
    }
    
    const volumeSlider = document.getElementById('volumeSlider');
    if (volumeSlider) {
        volumeSlider.addEventListener('input', (e) => {
            const videos = document.querySelectorAll('video');
            videos.forEach(video => {
                video.volume = e.target.value / 100;
            });
        });
    }
}

setTimeout(fixButtonHandlers, 2000);

// Show smart welcome message based on game
function showWelcomeChat() {
    const chatDiv = document.getElementById('liveChatMessages');
    const welcomeMsg = document.createElement('div');
    welcomeMsg.style.cssText = 'margin-bottom: 6px; padding: 8px 12px; background: rgba(0,255,136,0.3); border-radius: 15px; backdrop-filter: blur(8px); border: 1px solid rgba(0,255,136,0.5); animation: slideIn 0.3s ease;';
    
    // Get smart welcome message based on stream context
    fetch('/get_smart_welcome/{{ stream_id }}')
        .then(response => response.json())
        .then(data => {
            welcomeMsg.innerHTML = `<strong style="color: #00ff88; font-size: 12px;">🎮 SkillStake AI:</strong> <span style="color: white; font-size: 13px;">${data.message}</span>`;
            chatDiv.appendChild(welcomeMsg);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        })
        .catch(() => {
            welcomeMsg.innerHTML = `<strong style="color: #00ff88; font-size: 12px;">🎮 SkillStake AI:</strong> <span style="color: white; font-size: 13px;">🔥 Stream is LIVE! Drop a follow and let's see some epic gameplay! 💪</span>`;
            chatDiv.appendChild(welcomeMsg);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        });
}

// Live chat functions
function sendLiveChat() {
    const input = document.getElementById('liveChatInput');
    const message = input.value.trim();
    
    if (message) {
        fetch('/send_stream_chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                stream_id: parseInt('{{ stream_id }}'),
                message: message
            })
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                input.value = '';
                // Immediately reload chat to show new message
                loadLiveChat();
            }
        })
        .catch(err => console.error('Chat send failed:', err));
    }
}

// Load live chat messages with mentions and gifts
function loadLiveChat() {
    fetch('/get_stream_chat/{{ stream_id }}')
        .then(response => response.json())
        .then(data => {
            if (data.messages && data.messages.length > 0) {
                const chatDiv = document.getElementById('liveChatMessages');
                if (chatDiv) {
                    chatDiv.innerHTML = data.messages.map(msg => {
                        let messageContent = msg.message;
                        
                        // Handle @ mentions
                        messageContent = messageContent.replace(/@(\w+)/g, '<span style="color: #4ecdc4; font-weight: bold;">@$1</span>');
                        
                        // Handle gift messages
                        if (msg.message.includes('♦ sent')) {
                            return `<div style="margin-bottom: 8px; padding: 8px 12px; background: linear-gradient(45deg, #ff6b6b, #ffd93d); border-radius: 15px; max-width: 280px; word-wrap: break-word; animation: giftPulse 0.5s ease;">
                                <strong style="color: white; font-size: 12px;">${msg.username}</strong> <span style="color: white; font-size: 13px;">${messageContent}</span>
                            </div>`;
                        }
                        
                        // Check for funny words to trigger laugh
                        const funnyWords = ['lol', 'haha', 'funny', 'joke', 'laugh', 'comedy', 'hilarious', 'rofl', 'lmao'];
                        const hasFunnyWord = funnyWords.some(word => msg.message.toLowerCase().includes(word));
                        
                        if (hasFunnyWord && msg.username === '{{ session.username }}') {
                            triggerLaughReaction();
                        }
                        
                        return `<div style="margin-bottom: 6px; padding: 6px 10px; background: rgba(0,0,0,0.2); border-radius: 15px; backdrop-filter: blur(3px); border: 1px solid rgba(255,255,255,0.1); max-width: 280px; word-wrap: break-word;">
                            <strong style="color: #00ff88; font-size: 12px;">${msg.username}:</strong> <span style="color: white; font-size: 13px;">${messageContent}</span>
                        </div>`;
                    }).join('');
                    chatDiv.scrollTop = chatDiv.scrollHeight;
                }
            }
        })
        .catch(err => console.log('Live chat error:', err));
}

// Auto-show welcome and chat
// Welcome message will be shown after interface loads

// Add CSS animation
const style = document.createElement('style');
style.textContent = `
@keyframes slideIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}
`;
document.head.appendChild(style);

// Enhanced chat functionality
let currentViewers = [];

// @ Mention functionality
document.addEventListener('input', (e) => {
    if (e.target.id === 'liveChatInput') {
        const input = e.target.value;
        const atIndex = input.lastIndexOf('@');
        
        if (atIndex !== -1 && atIndex === input.length - 1) {
            showMentionSuggestions();
        } else if (atIndex !== -1) {
            const query = input.substring(atIndex + 1);
            filterMentionSuggestions(query);
        } else {
            hideMentionSuggestions();
        }
    }
});

// Enter key for live chat
document.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && document.activeElement.id === 'liveChatInput') {
        e.preventDefault();
        sendLiveChat();
    }
});

// Gift and Share functions
function toggleGifts() {
    const panel = document.getElementById('giftPanel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    document.getElementById('sharePanel').style.display = 'none';
}

function toggleShare() {
    const panel = document.getElementById('sharePanel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    document.getElementById('giftPanel').style.display = 'none';
}

function shareStream() {
    toggleShare();
}

function sendGift(amount, emoji) {
    // Prevent stream owner from gifting themselves
    if ({{ 'true' if session.user_id == stream[1] else 'false' }}) {
        alert('You cannot gift yourself!');
        return;
    }
    
    const balance = parseInt(document.getElementById('userBalance').textContent);
    
    if (balance < amount) {
        alert(`Insufficient balance! You need KSh ${amount} but have KSh ${balance}`);
        return;
    }
    
    fetch('/send_gift', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            stream_id: {{ stream_id }},
            amount: amount,
            emoji: emoji
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('userBalance').textContent = data.new_balance;
            toggleGifts();
            
            // Show gift animation
            showGiftAnimation(emoji, amount);
            
            // Add gift message to chat with auto-disappear
            const giftMessage = `♦ sent ${emoji} worth KSh ${amount}!`;
            fetch('/send_stream_chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    stream_id: {{ stream_id }},
                    message: giftMessage
                })
            });
            
            // Show gift sender name for 5 seconds
            showGiftSender(amount);
        } else {
            alert('Failed to send gift: ' + data.error);
        }
    })
    .catch(err => {
        console.error('Gift send failed:', err);
        alert('Failed to send gift');
    });
}

function showGiftAnimation(emoji, amount) {
    // Small gift animation (floating)
    if (amount < 500) {
        createFloatingGift(emoji, amount);
    } else {
        // Big gift celebration
        showBigGiftCelebration(emoji, amount);
    }
}

function createFloatingGift(emoji, amount) {
    const container = document.getElementById('giftAnimations');
    const gift = document.createElement('div');
    
    gift.innerHTML = `
        <div style="font-size: 32px;">${emoji}</div>
        <div style="color: #ffd93d; font-weight: bold; font-size: 12px;">+${amount}</div>
    `;
    
    const startX = Math.random() * window.innerWidth;
    gift.style.cssText = `
        position: absolute;
        left: ${startX}px;
        bottom: 0;
        text-align: center;
        animation: floatUp 3s ease-out forwards;
        z-index: 26;
    `;
    
    container.appendChild(gift);
    setTimeout(() => gift.remove(), 3000);
}

function showBigGiftCelebration(emoji, amount) {
    const celebration = document.getElementById('bigGiftCelebration');
    const icon = document.getElementById('bigGiftIcon');
    const text = document.getElementById('bigGiftText');
    const cheer = document.getElementById('bigGiftCheer');
    
    icon.textContent = emoji;
    text.textContent = `KSh ${amount} Gift!`;
    
    // Different cheers based on gift amount
    let cheerText = '';
    if (amount >= 2000) {
        cheerText = 'LEGENDARY GIFT! Amazing support!';
        triggerConfetti();
    } else if (amount >= 1000) {
        cheerText = 'WOW! Incredible generosity!';
        triggerSparkles();
    } else if (amount >= 500) {
        cheerText = 'Awesome gift! Thank you!';
        triggerClaps();
    }
    
    cheer.textContent = cheerText;
    
    celebration.style.display = 'block';
    celebration.style.animation = 'bigGiftPulse 3s ease-out forwards';
    
    setTimeout(() => {
        celebration.style.display = 'none';
    }, 3000);
}

function triggerConfetti() {
    for (let i = 0; i < 20; i++) {
        setTimeout(() => {
            createConfettiPiece();
        }, i * 100);
    }
}

function createConfettiPiece() {
    const confetti = document.createElement('div');
    const colors = ['#ff6b6b', '#4ecdc4', '#ffd93d', '#667eea', '#ff8e8e'];
    const color = colors[Math.floor(Math.random() * colors.length)];
    
    confetti.style.cssText = `
        position: absolute;
        width: 10px;
        height: 10px;
        background: ${color};
        top: 0;
        left: ${Math.random() * 100}%;
        animation: confettiFall 2s ease-out forwards;
        z-index: 31;
    `;
    
    document.getElementById('giftAnimations').appendChild(confetti);
    setTimeout(() => confetti.remove(), 2000);
}

function triggerSparkles() {
    for (let i = 0; i < 15; i++) {
        setTimeout(() => {
            createSparkle();
        }, i * 150);
    }
}

function createSparkle() {
    const sparkle = document.createElement('div');
    sparkle.textContent = '✦';
    sparkle.style.cssText = `
        position: absolute;
        font-size: 20px;
        color: #ffd700;
        top: ${Math.random() * 80}%;
        left: ${Math.random() * 90}%;
        animation: sparkleGlow 1.5s ease-out forwards;
        z-index: 27;
    `;
    
    document.getElementById('giftAnimations').appendChild(sparkle);
    setTimeout(() => sparkle.remove(), 1500);
}

function triggerClaps() {
    const claps = document.createElement('div');
    claps.innerHTML = '♪ ♪ ♪';
    claps.style.cssText = `
        position: absolute;
        top: 20%;
        left: 50%;
        transform: translateX(-50%);
        font-size: 48px;
        color: #4ecdc4;
        animation: clapBounce 2s ease-out forwards;
        z-index: 28;
    `;
    
    document.getElementById('giftAnimations').appendChild(claps);
    setTimeout(() => claps.remove(), 2000);
}

function triggerLaughReaction() {
    const laugh = document.createElement('div');
    laugh.innerHTML = 'HAHA ♪';
    laugh.style.cssText = `
        position: absolute;
        top: 30%;
        right: 10%;
        font-size: 24px;
        color: #ffd93d;
        font-weight: bold;
        animation: laughShake 2s ease-out forwards;
        z-index: 29;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    `;
    
    document.getElementById('giftAnimations').appendChild(laugh);
    setTimeout(() => laugh.remove(), 2000);
}

function showGiftSender(amount) {
    const sender = document.createElement('div');
    sender.innerHTML = `{{ session.username }} sent KSh ${amount}`;
    sender.style.cssText = `
        position: absolute;
        top: 15%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255,215,0,0.9);
        color: black;
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 14px;
        z-index: 32;
        animation: fadeInOut 5s ease-out forwards;
    `;
    
    document.getElementById('giftAnimations').appendChild(sender);
    setTimeout(() => sender.remove(), 5000);
}

// Add tap to like functionality with chat display
let likeCount = 0;
let tapTimer = null;
let isTapping = false;

document.addEventListener('click', (e) => {
    if (e.target.closest('#liveChatOverlay') || e.target.closest('#giftPanel') || e.target.closest('#sharePanel')) {
        return; // Don't trigger on UI elements
    }
    
    createLikeHeart(e.clientX, e.clientY);
    likeCount++;
    isTapping = true;
    
    // Clear existing timer
    if (tapTimer) {
        clearTimeout(tapTimer);
    }
    
    // Set timer to detect when user stops tapping
    tapTimer = setTimeout(() => {
        if (likeCount > 0) {
            // Show likes in chat when user stops tapping
            showLikesInChat(likeCount);
            
            // Send likes to server
            fetch('/send_stream_like', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    stream_id: {{ stream_id }},
                    likes: likeCount
                })
            });
            
            // Reset counter
            likeCount = 0;
        }
        isTapping = false;
    }, 1500); // 1.5 seconds after last tap
});

function showLikesInChat(count) {
    const chatDiv = document.getElementById('liveChatMessages');
    const likeMsg = document.createElement('div');
    
    let hearts = '';
    for (let i = 0; i < Math.min(count, 10); i++) {
        hearts += '♥ ';
    }
    
    likeMsg.innerHTML = `<span style="color: #ff6b6b; font-size: 16px;">${hearts}</span> {{ session.username }} sent ${count} likes!`;
    likeMsg.style.cssText = 'margin-bottom: 6px; padding: 6px 10px; background: rgba(255,107,107,0.3); border-radius: 15px; backdrop-filter: blur(3px); border: 1px solid rgba(255,107,107,0.3); max-width: 280px; word-wrap: break-word; animation: giftPulse 0.5s ease;';
    
    chatDiv.appendChild(likeMsg);
    chatDiv.scrollTop = chatDiv.scrollHeight;
    
    // Remove like message after 5 seconds
    setTimeout(() => {
        if (likeMsg.parentNode) {
            likeMsg.remove();
        }
    }, 5000);
}

function createLikeHeart(x, y) {
    const heart = document.createElement('div');
    heart.innerHTML = '♥';
    heart.style.cssText = `
        position: fixed;
        left: ${x}px;
        top: ${y}px;
        color: #ff6b6b;
        font-size: 24px;
        pointer-events: none;
        z-index: 35;
        animation: heartFloat 2s ease-out forwards;
    `;
    
    document.body.appendChild(heart);
    setTimeout(() => heart.remove(), 2000);
}

function showMentionNotification(mentioner) {
    const notification = document.createElement('div');
    notification.innerHTML = `${mentioner} mentioned you!`;
    notification.style.cssText = `
        position: absolute;
        top: 10%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(78,205,196,0.9);
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 14px;
        z-index: 33;
        animation: mentionPulse 3s ease-out forwards;
    `;
    
    document.getElementById('giftAnimations').appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

function updateAllBalanceDisplays(newBalance) {
    // Update all balance displays on the page
    const balanceElements = document.querySelectorAll('[id*="Balance"], [id*="balance"]');
    balanceElements.forEach(el => {
        if (el.textContent.includes('KSh') || el.textContent.match(/\d+/)) {
            el.textContent = newBalance;
        }
    });
}

// Share functions
function shareToWhatsApp() {
    const text = `Check out this live gaming stream on SkillStake! ${window.location.href}`;
    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
}

function shareToTelegram() {
    const text = `Live gaming stream on SkillStake! ${window.location.href}`;
    window.open(`https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(text)}`, '_blank');
}

function shareToFacebook() {
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}`, '_blank');
}

function shareToInstagram() {
    copyShareLink();
    alert('Link copied! Paste it in your Instagram story or bio.');
}

function copyShareLink() {
    const link = document.getElementById('shareLink');
    link.select();
    document.execCommand('copy');
    
    // Show feedback
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = '✅ Copied!';
    setTimeout(() => btn.textContent = originalText, 2000);
}

// Mention suggestions
function showMentionSuggestions() {
    fetch('/get_stream_viewers/{{ stream_id }}')
        .then(response => response.json())
        .then(data => {
            currentViewers = data.viewers || [];
            displayMentionSuggestions(currentViewers);
        });
}

function filterMentionSuggestions(query) {
    const filtered = currentViewers.filter(viewer => 
        viewer.username.toLowerCase().includes(query.toLowerCase())
    );
    displayMentionSuggestions(filtered);
}

function displayMentionSuggestions(viewers) {
    const suggestions = document.getElementById('mentionSuggestions');
    
    if (viewers.length === 0) {
        suggestions.style.display = 'none';
        return;
    }
    
    suggestions.innerHTML = viewers.slice(0, 5).map(viewer => 
        `<div onclick="selectMention('${viewer.username}')" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.1); color: white;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
            @${viewer.username}
        </div>`
    ).join('');
    
    suggestions.style.display = 'block';
}

function selectMention(username) {
    const input = document.getElementById('liveChatInput');
    const value = input.value;
    const atIndex = value.lastIndexOf('@');
    
    input.value = value.substring(0, atIndex) + `@${username} `;
    input.focus();
    hideMentionSuggestions();
}

function hideMentionSuggestions() {
    document.getElementById('mentionSuggestions').style.display = 'none';
}

// Add CSS animations
const giftStyles = document.createElement('style');
giftStyles.textContent = `
@keyframes giftPulse {
    0% { transform: scale(0.8); opacity: 0; }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); opacity: 1; }
}

@keyframes giftBounce {
    0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
    50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
    100% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
}

@keyframes floatUp {
    0% { transform: translateY(0); opacity: 1; }
    100% { transform: translateY(-200px); opacity: 0; }
}

@keyframes bigGiftPulse {
    0% { transform: scale(0); opacity: 0; }
    20% { transform: scale(1.1); opacity: 1; }
    80% { transform: scale(1); opacity: 1; }
    100% { transform: scale(0); opacity: 0; }
}

@keyframes confettiFall {
    0% { transform: translateY(0) rotate(0deg); opacity: 1; }
    100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
}

@keyframes sparkleGlow {
    0% { transform: scale(0); opacity: 0; }
    50% { transform: scale(1.5); opacity: 1; }
    100% { transform: scale(0); opacity: 0; }
}

@keyframes clapBounce {
    0%, 20%, 40%, 60%, 80% { transform: translateX(-50%) translateY(0); }
    10%, 30%, 50%, 70% { transform: translateX(-50%) translateY(-10px); }
    100% { transform: translateX(-50%) translateY(0); opacity: 0; }
}

@keyframes laughShake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}

@keyframes fadeInOut {
    0% { opacity: 0; transform: translateX(-50%) scale(0.8); }
    20% { opacity: 1; transform: translateX(-50%) scale(1); }
    80% { opacity: 1; transform: translateX(-50%) scale(1); }
    100% { opacity: 0; transform: translateX(-50%) scale(0.8); }
}

@keyframes heartFloat {
    0% { transform: translateY(0) scale(1); opacity: 1; }
    100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
}

@keyframes mentionPulse {
    0% { transform: translateX(-50%) scale(0.8); opacity: 0; }
    20% { transform: translateX(-50%) scale(1.1); opacity: 1; }
    80% { transform: translateX(-50%) scale(1); opacity: 1; }
    100% { transform: translateX(-50%) scale(0.8); opacity: 0; }
}

#liveChatMessages::-webkit-scrollbar {
    width: 4px;
}

#liveChatMessages::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.1);
    border-radius: 2px;
}

#liveChatMessages::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.3);
    border-radius: 2px;
}
`;
document.head.appendChild(giftStyles);

// Add click handler after DOM loads
setTimeout(() => {
    const sendBtn = document.querySelector('[onclick="sendLiveChat()"]');
    if (sendBtn) {
        sendBtn.addEventListener('click', (e) => {
            e.preventDefault();
            sendLiveChat();
        });
    }
}, 1000);
</script>
{% endblock %}