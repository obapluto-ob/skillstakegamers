{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2>⚔️ My Matches</h2>
    
    {% if matches %}
        {% for match in matches %}
        <div class="match-card">
            <div class="match-header">
                <div><strong>{{ match[1]|title }}</strong> - {{ match[2] }}</div>
                <span class="status-badge status-{{ match[10] }}">{{ match[10] }}</span>
            </div>
            <div style="margin: 1rem 0;">
                <strong>{{ match[4] }}</strong> VS <strong>{{ match[6] or 'Waiting for opponent...' }}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <strong>Stake: KSh {{ "%.0f"|format(match[7]) }}</strong>
                    <strong style="margin-left: 1rem;">Pot: KSh {{ "%.0f"|format(match[8]) }}</strong>
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                    {% if match[1] == 'fpl_battles' and match[10] == 'active' %}
                        <a href="{{ url_for('live_battle', match_id=match[0]) }}" class="btn btn-success btn-sm">View Live Battle</a>
                    {% endif %}
                    {% if match[10] == 'open' and match[3] == session.user_id %}
                        <button onclick="cancelMatch({{ match[0] }}, 'free')" class="btn btn-warning btn-sm">Cancel (Free)</button>
                    {% elif match[10] == 'active' and (match[3] == session.user_id or match[5] == session.user_id) and match[1] != 'fpl_battles' %}
                        <button onclick="cancelMatch({{ match[0] }}, 'penalty')" class="btn btn-danger btn-sm">Cancel (10% Penalty)</button>
                    {% endif %}
                    <div style="color: #ccc; font-size: 0.9rem;">
                        {{ match[15] }}
                    </div>
                </div>
            </div>
            
            {% if match[1] == 'fpl_battles' and match[10] == 'active' %}
            <div style="margin-top: 1rem; padding: 1rem; background: rgba(23, 162, 184, 0.1); border-radius: 8px;">
                <h6 style="margin: 0 0 0.5rem 0; color: #17a2b8;">FPL Battle Info</h6>
                <p style="margin: 0; font-size: 0.9rem;">Competition Mode: {{ match[2]|title }}</p>
                <p style="margin: 0; font-size: 0.8rem; color: #ccc;">Battle will auto-resolve when gameweek ends. No manual input required.</p>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    {% else %}
        <div style="text-align: center; padding: 2rem; background: rgba(255,255,255,0.05); border-radius: 10px;">
            <h4 style="color: #00ff88;">No matches yet!</h4>
            <p>Create your first match to start earning.</p>
            <a href="{{ url_for('quick_matches') }}" class="btn btn-success">Create Match</a>
        </div>
    {% endif %}
</div>
<script>
function cancelMatch(matchId, penaltyType) {
    const penaltyText = penaltyType === 'free' ? 'no penalty' : '10% penalty (KSh will be deducted)';
    const confirmText = `Cancel this match? ${penaltyType === 'free' ? 'Free cancellation.' : 'You will pay a 10% penalty.'}`;
    
    if (confirm(confirmText)) {
        fetch(`/cancel_match/${matchId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error cancelling match');
        });
    }
}
</script>
{% endblock %}